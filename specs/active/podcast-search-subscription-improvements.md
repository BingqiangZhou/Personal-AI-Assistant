# æ’­å®¢æœç´¢è®¢é˜…åŠŸèƒ½æ”¹è¿›éœ€æ±‚æ–‡æ¡£
# Podcast Search Subscription Improvements Requirements

**éœ€æ±‚ç¼–å· / Requirement ID**: PRD-2025-001
**åˆ›å»ºæ—¥æœŸ / Created**: 2025-01-13
**ä¼˜å…ˆçº§ / Priority**: P1 - é«˜ä¼˜å…ˆçº§
**çŠ¶æ€ / Status**: è¿›è¡Œä¸­ / In Progress

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿° / Overview

### é—®é¢˜æè¿° / Problem Description

ç”¨æˆ·åœ¨æ’­å®¢é¡µé¢æœç´¢æ’­å®¢æ—¶é‡åˆ°ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

1. **è®¢é˜…çŠ¶æ€æ˜¾ç¤ºä¸å‡†ç¡®**
   - æœç´¢ç»“æœä¸­æœªæ­£ç¡®æ˜¾ç¤ºå·²è®¢é˜…çš„æ’­å®¢
   - å·²è®¢é˜…çš„æ’­å®¢ä»æ˜¾ç¤ºä¸º"æœªè®¢é˜…"çŠ¶æ€

2. **è®¢é˜…è¿‡ç¨‹ç¼ºå°‘ç”¨æˆ·åé¦ˆ**
   - ç‚¹å‡»è®¢é˜…æŒ‰é’®åæ²¡æœ‰ä»»ä½•è§†è§‰åé¦ˆ
   - ç”¨æˆ·ä¸çŸ¥é“è®¢é˜…æ“ä½œæ˜¯å¦æ­£åœ¨æ‰§è¡Œ
   - å¯èƒ½å¯¼è‡´é‡å¤ç‚¹å‡»è®¢é˜…æŒ‰é’®

### å½±å“èŒƒå›´ / Impact

- **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·æ— æ³•å‡†ç¡®åˆ¤æ–­æ’­å®¢æ˜¯å¦å·²è®¢é˜…
- **äº¤äº’ä½“éªŒ**: è®¢é˜…æ“ä½œç¼ºå°‘åé¦ˆï¼Œç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘
- **æ•°æ®ä¸€è‡´æ€§**: å¯èƒ½å¯¼è‡´é‡å¤è®¢é˜…

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹ / User Stories

### æ•…äº‹1: è®¢é˜…çŠ¶æ€å‡†ç¡®æ˜¾ç¤º
**ä½œä¸º** ä¸€ä¸ªæ’­å®¢è®¢é˜…ç”¨æˆ·
**æˆ‘æƒ³è¦** åœ¨æœç´¢ç»“æœä¸­çœ‹åˆ°å‡†ç¡®çš„è®¢é˜…çŠ¶æ€
**ä»¥ä¾¿** æˆ‘å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“å“ªäº›æ’­å®¢å·²ç»è®¢é˜…

### æ•…äº‹2: è®¢é˜…æ“ä½œæœ‰åé¦ˆ
**ä½œä¸º** ä¸€ä¸ªæ’­å®¢è®¢é˜…ç”¨æˆ·
**æˆ‘æƒ³è¦** åœ¨è®¢é˜…æ—¶çœ‹åˆ°åŠ è½½åŠ¨ç”»æˆ–è¿›åº¦æç¤º
**ä»¥ä¾¿** æˆ‘çŸ¥é“ç³»ç»Ÿæ­£åœ¨å¤„ç†æˆ‘çš„è¯·æ±‚

---

## âœ… éªŒæ”¶æ ‡å‡† / Acceptance Criteria

### AC1: è®¢é˜…çŠ¶æ€å‡†ç¡®æ˜¾ç¤º

- [ ] æœç´¢ç»“æœä¸­çš„è®¢é˜…çŠ¶æ€å¿…é¡»å‡†ç¡®åæ˜ å®é™…è®¢é˜…æƒ…å†µ
- [ ] å·²è®¢é˜…çš„æ’­å®¢æ˜¾ç¤ºç»¿è‰²å¯¹å‹¾å›¾æ ‡
- [ ] æœªè®¢é˜…çš„æ’­å®¢æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
- [ ] æ”¯æŒ URL è§„èŒƒåŒ–æ¯”è¾ƒï¼ˆå¤„ç† http/httpsã€å°¾éƒ¨æ–œæ ç­‰å·®å¼‚ï¼‰

### AC2: è®¢é˜…åŠ è½½çŠ¶æ€

- [ ] ç‚¹å‡»è®¢é˜…æŒ‰é’®åç«‹å³æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- [ ] åŠ è½½è¿‡ç¨‹ä¸­ç¦ç”¨è®¢é˜…æŒ‰é’®
- [ ] è®¢é˜…æˆåŠŸåæ›´æ–°çŠ¶æ€ä¸ºå·²è®¢é˜…
- [ ] è®¢é˜…å¤±è´¥åæ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶æ¢å¤æŒ‰é’®

### AC3: è¿‡æ¸¡åŠ¨ç”»

- [ ] è®¢é˜…çŠ¶æ€åˆ‡æ¢æ—¶æœ‰å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»
- [ ] ä»"æœªè®¢é˜…"åˆ°"å·²è®¢é˜…"çš„çŠ¶æ€å˜åŒ–æœ‰è§†è§‰åé¦ˆ
- [ ] ä»"è®¢é˜…ä¸­"åˆ°"å·²è®¢é˜…"çš„åˆ‡æ¢æµç•…

---

## ğŸ”§ æŠ€æœ¯è¦æ±‚ / Technical Requirements

### å‰ç«¯ (Flutter)

#### 1. è®¢é˜…çŠ¶æ€åˆ¤æ–­é€»è¾‘æ”¹è¿›

**å½“å‰é—®é¢˜ä»£ç ** (`search_panel.dart:381-383`):
```dart
final isSubscribed = subscriptionState.subscriptions.any(
  (sub) => sub.sourceUrl == result.feedUrl,
);
```

**é—®é¢˜åˆ†æ**:
- ä½¿ç”¨ä¸¥æ ¼å­—ç¬¦ä¸²åŒ¹é…ï¼ŒURL æ ¼å¼å·®å¼‚ä¼šå¯¼è‡´åŒ¹é…å¤±è´¥
- å¸¸è§å·®å¼‚ï¼š
  - åè®®: `http://` vs `https://`
  - å°¾éƒ¨æ–œæ : `example.com/feed` vs `example.com/feed/`
  - æŸ¥è¯¢å‚æ•°: `feed.xml` vs `feed.xml?param=value`
  - URL ç¼–ç å·®å¼‚

**è§£å†³æ–¹æ¡ˆ**:
åˆ›å»º URL è§„èŒƒåŒ–å·¥å…·å‡½æ•°:

```dart
/// è§„èŒƒåŒ– Feed URL ç”¨äºæ¯”è¾ƒ
String normalizeFeedUrl(String url) {
  var normalized = url.trim();

  // ç§»é™¤å°¾éƒ¨æ–œæ 
  if (normalized.endsWith('/')) {
    normalized = normalized.substring(0, normalized.length - 1);
  }

  // ç»Ÿä¸€è½¬å°å†™
  normalized = normalized.toLowerCase();

  // ç»Ÿä¸€åè®®ä¸º https (å¦‚æœåŸURLæ˜¯ http)
  if (normalized.startsWith('http://')) {
    normalized = normalized.replaceFirst('http://', 'https://');
  }

  return normalized;
}

/// æ¯”è¾ƒä¸¤ä¸ª Feed URL æ˜¯å¦ç›¸åŒ
bool feedUrlMatches(String? url1, String? url2) {
  if (url1 == null || url2 == null) return false;
  return normalizeFeedUrl(url1) == normalizeFeedUrl(url2);
}
```

**ä¿®æ”¹ä½ç½®**: `search_panel.dart` ç¬¬ 381-383 è¡Œ
```dart
// ä½¿ç”¨è§„èŒƒåŒ–æ¯”è¾ƒ
final isSubscribed = subscriptionState.subscriptions.any(
  (sub) => feedUrlMatches(sub.sourceUrl, result.feedUrl),
);
```

#### 2. è®¢é˜…åŠ è½½çŠ¶æ€

**æ–°å¢çŠ¶æ€ç®¡ç†**: åœ¨ `podcast_providers.dart` ä¸­æ·»åŠ è®¢é˜…ä¸­çŠ¶æ€

```dart
class PodcastSubscriptionState extends Equatable {
  final List<PodcastSubscriptionModel> subscriptions;
  final bool hasMore;
  final int? nextPage;
  final int currentPage;
  final int total;
  final bool isLoading;
  final bool isLoadingMore;
  final String? error;
  final Set<String> subscribingFeedUrls; // æ–°å¢ï¼šæ­£åœ¨è®¢é˜…çš„ Feed URLs
}
```

**ä¿®æ”¹ Provider**: æ·»åŠ è®¢é˜…çŠ¶æ€ç®¡ç†æ–¹æ³•

```dart
Future<PodcastSubscriptionModel> addSubscription({
  required String feedUrl,
  List<int>? categoryIds,
}) async {
  // æ ‡è®°ä¸ºè®¢é˜…ä¸­
  state = state.copyWith(
    subscribingFeedUrls: {...state.subscribingFeedUrls, feedUrl},
  );

  try {
    final subscription = await _repository.addSubscription(
      feedUrl: feedUrl,
      categoryIds: categoryIds,
    );

    await refreshSubscriptions();

    // ç§»é™¤è®¢é˜…ä¸­æ ‡è®°
    state = state.copyWith(
      subscribingFeedUrls: state.subscribingFeedUrls.where((url) => url != feedUrl).toSet(),
    );

    return subscription;
  } catch (error) {
    // ç§»é™¤è®¢é˜…ä¸­æ ‡è®°
    state = state.copyWith(
      subscribingFeedUrls: state.subscribingFeedUrls.where((url) => url != feedUrl).toSet(),
    );
    rethrow;
  }
}
```

#### 3. UI åŠ è½½åŠ¨ç”»

**ä¿®æ”¹ `podcast_search_result_card.dart`**:

```dart
// è®¢é˜…çŠ¶æ€æ˜¾ç¤º
Widget _buildSubscribeButton(
  BuildContext context,
  bool isSubscribed,
  bool isSubscribing,
) {
  final theme = Theme.of(context);
  final l10n = AppLocalizations.of(context)!;

  if (isSubscribed) {
    // å·²è®¢é˜…çŠ¶æ€
    return Tooltip(
      message: l10n.podcast_subscribed,
      child: Container(
        padding: const EdgeInsets.all(6),
        decoration: BoxDecoration(
          color: theme.colorScheme.primaryContainer,
          borderRadius: BorderRadius.circular(6),
        ),
        child: Icon(
          Icons.check_circle,
          color: theme.colorScheme.primary,
          size: 24,
        ),
      ),
    );
  }

  if (isSubscribing) {
    // è®¢é˜…ä¸­ - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    return SizedBox(
      width: 36,
      height: 36,
      child: CircularProgressIndicator(
        strokeWidth: 2,
        valueColor: AlwaysStoppedAnimation<Color>(
          theme.colorScheme.primary,
        ),
      ),
    );
  }

  // æœªè®¢é˜…çŠ¶æ€
  return Tooltip(
    message: l10n.podcast_subscribe,
    child: IconButton(
      onPressed: () => onSubscribe?.call(result),
      icon: const Icon(Icons.add_circle_outline),
      iconSize: 24,
      color: theme.colorScheme.onSurfaceVariant,
      padding: EdgeInsets.zero,
      constraints: const BoxConstraints(
        minWidth: 36,
        minHeight: 36,
      ),
    ),
  );
}
```

**æ·»åŠ è¿‡æ¸¡åŠ¨ç”»**:

```dart
AnimatedSwitcher(
  duration: const Duration(milliseconds: 300),
  transitionBuilder: (child, animation) {
    return FadeTransition(
      opacity: animation,
      child: ScaleTransition(
        scale: animation,
        child: child,
      ),
    );
  },
  child: _buildSubscribeButton(context, isSubscribed, isSubscribing),
)
```

#### 4. ä¿®æ”¹æœç´¢ç»“æœå¡ç‰‡ä¼ é€’è®¢é˜…çŠ¶æ€

**ä¿®æ”¹ `search_panel.dart`**:

```dart
return PodcastSearchResultCard(
  result: result,
  onSubscribe: widget.onSubscribe,
  isSubscribed: isSubscribed,
  isSubscribing: subscriptionState.subscribingFeedUrls.contains(result.feedUrl),
  searchCountry: searchState.searchCountry,
  key: ValueKey('search_${result.feedUrl}'),
);
```

#### 5. ä¿®æ”¹å¡ç‰‡ç»„ä»¶æ·»åŠ å‚æ•°

**ä¿®æ”¹ `podcast_search_result_card.dart`**:

```dart
const PodcastSearchResultCard({
  super.key,
  required this.result,
  required this.onSubscribe,
  required this.isSubscribed,
  required this.searchCountry,
  this.isSubscribing = false, // æ–°å¢å‚æ•°
});
```

---

## ğŸ“ æ¶‰åŠæ–‡ä»¶ / Files to Modify

### å‰ç«¯æ–‡ä»¶

1. **`frontend/lib/features/podcast/data/utils/podcast_url_utils.dart`** (æ–°å»º)
   - åˆ›å»º URL è§„èŒƒåŒ–å·¥å…·å‡½æ•°

2. **`frontend/lib/features/podcast/presentation/providers/podcast_providers.dart`**
   - æ·»åŠ  `subscribingFeedUrls` çŠ¶æ€
   - ä¿®æ”¹ `addSubscription` æ–¹æ³•

3. **`frontend/lib/features/podcast/presentation/widgets/search_panel.dart`**
   - ä½¿ç”¨è§„èŒƒåŒ– URL æ¯”è¾ƒ
   - ä¼ é€’è®¢é˜…ä¸­çŠ¶æ€

4. **`frontend/lib/features/podcast/presentation/widgets/podcast_search_result_card.dart`**
   - æ·»åŠ  `isSubscribing` å‚æ•°
   - æ·»åŠ åŠ è½½åŠ¨ç”» UI
   - æ·»åŠ è¿‡æ¸¡åŠ¨ç”»

5. **`frontend/lib/features/podcast/presentation/providers/podcast_state_models.dart`**
   - æ›´æ–° `PodcastSubscriptionState` æ¨¡å‹

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’ / Testing Plan

### å•å…ƒæµ‹è¯•

**`podcast_url_utils_test.dart`** (æ–°å»º)
- [ ] æµ‹è¯• URL è§„èŒƒåŒ–å‡½æ•°
- [ ] æµ‹è¯• http è½¬ https
- [ ] æµ‹è¯•ç§»é™¤å°¾éƒ¨æ–œæ 
- [ ] æµ‹è¯• URL ç¼–ç å¤„ç†

### Widget æµ‹è¯•

**`podcast_search_result_card_test.dart`**
- [ ] æµ‹è¯•å·²è®¢é˜…çŠ¶æ€æ˜¾ç¤º
- [ ] æµ‹è¯•æœªè®¢é˜…çŠ¶æ€æ˜¾ç¤º
- [ ] æµ‹è¯•è®¢é˜…ä¸­åŠ è½½åŠ¨ç”»
- [ ] æµ‹è¯•è¿‡æ¸¡åŠ¨ç”»æ•ˆæœ

**`search_panel_test.dart`**
- [ ] æµ‹è¯•è®¢é˜…çŠ¶æ€åˆ¤æ–­å‡†ç¡®æ€§
- [ ] æµ‹è¯•è§„èŒƒåŒ– URL æ¯”è¾ƒ

### é›†æˆæµ‹è¯•

- [ ] å®Œæ•´è®¢é˜…æµç¨‹æµ‹è¯•
- [ ] è®¢é˜…çŠ¶æ€å®æ—¶æ›´æ–°æµ‹è¯•
- [ ] é‡å¤è®¢é˜…é˜²æŠ¤æµ‹è¯•

---

## ğŸ¨ UI/UX è®¾è®¡è§„èŒƒ / Design Guidelines

### åŠ è½½çŠ¶æ€è®¾è®¡

**Material 3 è®¾è®¡è§„èŒƒ**:
- ä½¿ç”¨ `CircularProgressIndicator` æ˜¾ç¤ºåŠ è½½
- é¢œè‰²ä½¿ç”¨ `theme.colorScheme.primary`
- å°ºå¯¸: 36x36 åƒç´ 

### è¿‡æ¸¡åŠ¨ç”»

**åŠ¨ç”»è§„æ ¼**:
- æŒç»­æ—¶é—´: 300ms
- åŠ¨ç”»ç±»å‹: `FadeTransition` + `ScaleTransition`
- ç¼©æ”¾èŒƒå›´: 0.8 â†’ 1.0
- é€æ˜åº¦: 0.0 â†’ 1.0

### å›¾æ ‡è§„èŒƒ

| çŠ¶æ€ | å›¾æ ‡ | é¢œè‰² | è¯´æ˜ |
|------|------|------|------|
| å·²è®¢é˜… | `Icons.check_circle` | `theme.colorScheme.primary` | ç»¿è‰²å¯¹å‹¾ |
| æœªè®¢é˜… | `Icons.add_circle_outline` | `theme.colorScheme.onSurfaceVariant` | æ·»åŠ æŒ‰é’® |
| è®¢é˜…ä¸­ | `CircularProgressIndicator` | `theme.colorScheme.primary` | åŠ è½½åŠ¨ç”» |

---

## ğŸš€ å®æ–½è®¡åˆ’ / Implementation Plan

### é˜¶æ®µ1: URL è§„èŒƒåŒ–
- [ ] åˆ›å»º `podcast_url_utils.dart`
- [ ] å®ç° URL è§„èŒƒåŒ–å‡½æ•°
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ä¿®æ”¹æœç´¢é¢æ¿ä½¿ç”¨è§„èŒƒåŒ–æ¯”è¾ƒ

### é˜¶æ®µ2: è®¢é˜…çŠ¶æ€ç®¡ç†
- [ ] æ›´æ–°çŠ¶æ€æ¨¡å‹
- [ ] ä¿®æ”¹ Provider æ·»åŠ è®¢é˜…ä¸­çŠ¶æ€
- [ ] æµ‹è¯•çŠ¶æ€ç®¡ç†

### é˜¶æ®µ3: UI æ”¹è¿›
- [ ] ä¿®æ”¹è®¢é˜…ç»“æœå¡ç‰‡æ·»åŠ åŠ è½½åŠ¨ç”»
- [ ] æ·»åŠ è¿‡æ¸¡åŠ¨ç”»æ•ˆæœ
- [ ] ç¼–å†™ Widget æµ‹è¯•

### é˜¶æ®µ4: é›†æˆæµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒéªŒè¯
- [ ] æ€§èƒ½æµ‹è¯•

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡ / Success Metrics

- [ ] è®¢é˜…çŠ¶æ€æ˜¾ç¤ºå‡†ç¡®ç‡è¾¾åˆ° 100%
- [ ] è®¢é˜…æ“ä½œåé¦ˆå»¶è¿Ÿ < 100ms
- [ ] åŠ¨ç”»æµç•…åº¦ > 60fps
- [ ] ç”¨æˆ·æ»¡æ„åº¦æå‡

---

## ğŸ“ å¤‡æ³¨ / Notes

1. **å‘åå…¼å®¹**: éœ€è¦è€ƒè™‘å·²å­˜åœ¨çš„å†å²æ•°æ®ï¼ŒURL æ ¼å¼å¯èƒ½ä¸ä¸€è‡´
2. **æ€§èƒ½**: URL è§„èŒƒåŒ–æ“ä½œåº”è¯¥åœ¨ UI çº¿ç¨‹å¤–æ‰§è¡Œï¼Œé¿å…å¡é¡¿
3. **å›½é™…åŒ–**: ç¡®ä¿é”™è¯¯æç¤ºå’ŒçŠ¶æ€æ–‡æœ¬æ”¯æŒåŒè¯­ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: è‰ç¨¿ / Draft
**æœ€åæ›´æ–°**: 2025-01-13
**å®¡æ ¸äºº**: å¾…åˆ†é… / Pending
