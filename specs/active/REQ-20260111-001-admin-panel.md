# 后台管理页面 - API Key 和 RSS 订阅管理

## 基本信息
- **需求ID**: REQ-20260111-001
- **创建日期**: 2026-01-11
- **最后更新**: 2026-01-11
- **负责人**: Product Manager
- **状态**: Active
- **优先级**: High

## 需求描述

### 用户故事
作为系统管理员，我想要一个后台管理页面来管理API Key和RSS订阅，以便能够方便地查看、创建、编辑和删除这些资源，提高系统管理效率。

### 业务价值
- **提高管理效率**: 通过Web界面直接管理API Key和RSS订阅，无需通过API或数据库操作
- **增强安全性**: 集中管理API Key，便于监控和控制访问权限
- **改善用户体验**: 提供直观的界面，降低管理门槛
- **成功指标**:
  - 管理员可以在5分钟内完成API Key的创建和配置
  - 管理页面响应时间 < 2秒
  - 零安全漏洞

### 背景信息
- **当前状况**: 目前只能通过API接口或直接操作数据库来管理API Key和RSS订阅
- **用户痛点**:
  - 缺少可视化管理界面
  - 需要技术背景才能进行管理操作
  - 无法快速查看所有资源的状态
- **机会点**:
  - 使用现代化的htmx技术实现无刷新交互
  - 提供简洁高效的管理界面
  - 增强系统的可管理性

## 功能需求

### 核心功能
- [FR-001] 管理员登录认证
- [FR-002] API Key管理（CRUD操作）
- [FR-003] RSS订阅管理（查看、编辑、删除）
- [FR-004] 安全访问控制

### 功能详述

#### 功能1：管理员登录认证
- **描述**: 提供安全的登录页面，只有认证用户才能访问管理功能
- **输入**: 用户名、密码
- **处理**:
  - 验证用户凭证
  - 生成会话token
  - 设置安全cookie
- **输出**:
  - 成功：跳转到管理首页
  - 失败：显示错误信息

#### 功能2：API Key管理
- **描述**: 完整的API Key生命周期管理
- **子功能**:
  - **查看列表**: 显示所有API Key及其状态（启用/禁用）、创建时间、最后使用时间
  - **创建新Key**: 生成新的API Key，设置名称和权限
  - **启用/禁用**: 切换API Key的激活状态
  - **删除Key**: 永久删除API Key（需要确认）
- **输入**:
  - 创建：Key名称、描述、权限范围
  - 更新：Key ID、新状态
  - 删除：Key ID
- **处理**:
  - 生成安全的随机API Key
  - 更新数据库记录
  - 记录操作日志
- **输出**:
  - 操作成功提示
  - 更新后的列表（通过htmx局部刷新）

#### 功能3：RSS订阅管理
- **描述**: 管理系统中的RSS订阅源
- **子功能**:
  - **查看列表**: 显示所有RSS订阅、标题、URL、状态、最后更新时间
  - **编辑订阅**: 修改订阅的标题、URL、更新频率
  - **删除订阅**: 删除RSS订阅（需要确认）
  - **手动刷新**: 触发立即更新订阅内容
- **输入**:
  - 编辑：订阅ID、新的标题/URL/频率
  - 删除：订阅ID
  - 刷新：订阅ID
- **处理**:
  - 验证RSS URL有效性
  - 更新数据库记录
  - 触发后台任务刷新内容
- **输出**:
  - 操作成功提示
  - 更新后的列表（通过htmx局部刷新）

#### 功能4：安全访问控制
- **描述**: 确保只有授权用户可以访问管理页面
- **输入**: 会话token/cookie
- **处理**:
  - 验证会话有效性
  - 检查用户权限
  - 记录访问日志
- **输出**:
  - 授权：允许访问
  - 未授权：重定向到登录页

## 非功能需求

### 性能要求
- **响应时间**: 页面加载 < 2秒，htmx交互 < 500ms
- **并发用户**: 支持至少10个管理员同时操作
- **处理能力**: 单页面可显示最多1000条记录（分页）

### 安全要求
- **身份验证**:
  - 使用JWT token或session cookie
  - 密码必须加密存储（bcrypt）
  - 支持会话超时（30分钟无操作）
- **数据加密**:
  - HTTPS传输
  - API Key在数据库中加密存储
- **权限控制**:
  - 只有管理员角色可以访问
  - 所有操作记录审计日志
  - CSRF保护

### 可用性要求
- **可用性**: 99.9%（与主应用一致）
- **恢复时间**: RTO < 1小时
- **降级方案**: 如果管理页面不可用，仍可通过API进行管理

### 兼容性要求
- **浏览器支持**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **移动设备**: 响应式设计，支持平板和手机访问
- **API版本**: 使用现有的 /api/v1/ 接口

## 技术实现方案

### 技术栈
- **后端框架**: FastAPI
- **模板引擎**: Jinja2
- **前端交互**: htmx (无需复杂JavaScript)
- **样式**: Tailwind CSS 或 Bootstrap 5
- **认证**: FastAPI依赖注入 + Session/JWT

### 架构设计
```
backend/
├── app/
│   ├── admin/                    # 新增管理模块
│   │   ├── __init__.py
│   │   ├── router.py            # 管理页面路由
│   │   ├── dependencies.py      # 认证依赖
│   │   ├── schemas.py           # 表单验证
│   │   └── templates/           # Jinja2模板
│   │       ├── base.html        # 基础模板
│   │       ├── login.html       # 登录页
│   │       ├── dashboard.html   # 管理首页
│   │       ├── apikeys.html     # API Key管理
│   │       └── subscriptions.html # RSS订阅管理
│   └── main.py                  # 注册管理路由
```

### URL结构
```
/admin/                          # 管理首页（需要登录）
/admin/login                     # 登录页
/admin/logout                    # 登出
/admin/apikeys                   # API Key管理页
/admin/apikeys/create            # 创建API Key (htmx POST)
/admin/apikeys/{id}/toggle       # 启用/禁用 (htmx PUT)
/admin/apikeys/{id}/delete       # 删除 (htmx DELETE)
/admin/subscriptions             # RSS订阅管理页
/admin/subscriptions/{id}/edit   # 编辑订阅 (htmx PUT)
/admin/subscriptions/{id}/delete # 删除订阅 (htmx DELETE)
/admin/subscriptions/{id}/refresh # 手动刷新 (htmx POST)
```

## 任务分解

### Backend任务
- [ ] [TASK-B-001] 创建admin模块基础结构
  - **负责人**: Backend Developer
  - **验收标准**:
    - [ ] 创建admin目录和基础文件
    - [ ] 配置Jinja2模板引擎
    - [ ] 配置静态文件服务
  - **依赖**: 无
  - **状态**: Todo

- [ ] [TASK-B-002] 实现管理员认证系统
  - **负责人**: Backend Developer
  - **验收标准**:
    - [ ] 登录页面和登录接口
    - [ ] Session/JWT管理
    - [ ] 认证依赖注入
    - [ ] 登出功能
  - **依赖**: TASK-B-001
  - **状态**: Todo

- [ ] [TASK-B-003] 实现API Key管理接口
  - **负责人**: Backend Developer
  - **验收标准**:
    - [ ] 列表页面渲染
    - [ ] 创建API Key接口
    - [ ] 启用/禁用接口
    - [ ] 删除接口
    - [ ] htmx响应格式正确
  - **依赖**: TASK-B-002
  - **状态**: Todo

- [ ] [TASK-B-004] 实现RSS订阅管理接口
  - **负责人**: Backend Developer
  - **验收标准**:
    - [ ] 列表页面渲染
    - [ ] 编辑订阅接口
    - [ ] 删除订阅接口
    - [ ] 手动刷新接口
    - [ ] htmx响应格式正确
  - **依赖**: TASK-B-002
  - **状态**: Todo

- [ ] [TASK-B-005] 实现安全防护
  - **负责人**: Backend Developer
  - **验收标准**:
    - [ ] CSRF保护
    - [ ] XSS防护
    - [ ] 操作审计日志
    - [ ] 会话超时处理
  - **依赖**: TASK-B-002
  - **状态**: Todo

### 测试任务
- [ ] [TASK-T-001] 编写管理页面测试
  - **负责人**: Test Engineer
  - **验收标准**:
    - [ ] 认证流程测试
    - [ ] API Key管理功能测试
    - [ ] RSS订阅管理功能测试
    - [ ] 安全测试（未授权访问、CSRF等）
    - [ ] 测试覆盖率 > 80%
  - **依赖**: TASK-B-005
  - **状态**: Todo

### DevOps任务
- [ ] [TASK-D-001] 配置管理页面部署
  - **负责人**: DevOps Engineer
  - **验收标准**:
    - [ ] Docker配置包含静态文件
    - [ ] HTTPS配置
    - [ ] 访问日志配置
  - **依赖**: TASK-T-001
  - **状态**: Todo

## 验收标准

### 整体验收
- [ ] 所有功能需求已实现
- [ ] 性能指标达标（响应时间 < 2秒）
- [ ] 安全测试通过（无SQL注入、XSS、CSRF漏洞）
- [ ] 用户验收测试通过

### 用户验收标准
- [ ] 管理员可以成功登录管理页面
- [ ] 管理员可以创建、查看、启用/禁用、删除API Key
- [ ] 管理员可以查看、编辑、删除RSS订阅
- [ ] 未登录用户无法访问管理页面
- [ ] 所有操作都有明确的成功/失败反馈
- [ ] 页面响应时间符合要求
- [ ] 界面直观易用，无需培训即可操作

### 技术验收标准
- [ ] 代码质量达标（通过black、mypy检查）
- [ ] 测试覆盖率 > 80%
- [ ] API文档完整
- [ ] 安全扫描通过
- [ ] 性能测试通过

## 设计约束

### 技术约束
- 必须使用FastAPI + Jinja2 + htmx技术栈
- 必须集成现有的用户认证系统
- 必须使用现有的数据库模型（User、Subscription等）
- 必须遵循项目的DDD架构模式

### 业务约束
- 只有管理员角色可以访问
- 不能影响现有API的功能
- 必须保持与现有系统的一致性

### 环境约束
- 部署在Docker容器中
- 使用现有的PostgreSQL数据库
- 使用现有的Redis缓存

## 风险评估

### 技术风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| htmx学习曲线 | 中 | 低 | 提供示例代码和文档，htmx本身很简单 |
| 认证集成复杂 | 低 | 中 | 使用FastAPI成熟的依赖注入模式 |
| CSRF攻击风险 | 中 | 高 | 实现CSRF token验证 |

### 业务风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 权限管理不当 | 低 | 高 | 严格的权限检查和审计日志 |
| 数据泄露 | 低 | 高 | 加密存储、HTTPS传输、访问日志 |

## 依赖关系

### 外部依赖
- FastAPI - Web框架
- Jinja2 - 模板引擎
- htmx - 前端交互库
- Tailwind CSS/Bootstrap - 样式框架

### 内部依赖
- app/core/security - 认证和授权
- app/domains/user - 用户模型
- app/domains/subscription - 订阅模型
- app/core/database - 数据库连接

## UI/UX设计要求

### 设计原则
- **简洁**: 界面简洁明了，突出核心功能
- **高效**: 常用操作一键完成，减少点击次数
- **安全**: 危险操作需要二次确认
- **响应式**: 支持桌面和移动设备

### 页面布局
```
+----------------------------------+
|  Logo  |  管理后台  |  [登出]    |
+----------------------------------+
| 侧边栏  |      主内容区          |
| - 首页  |                        |
| - API  |   [表格/表单]          |
| - RSS  |                        |
+----------------------------------+
```

### 交互设计
- 使用htmx实现无刷新交互
- 操作后显示toast提示
- 删除操作需要确认对话框
- 表单验证实时反馈

## 变更记录

| 版本 | 日期 | 变更内容 | 变更人 | 审批人 |
|------|------|----------|--------|--------|
| 1.0 | 2026-01-11 | 初始创建 | Product Manager | - |

## 相关文档

- [FastAPI文档](https://fastapi.tiangolo.com/)
- [htmx文档](https://htmx.org/)
- [Jinja2文档](https://jinja.palletsprojects.com/)

## 审批

### 需求评审
- [ ] 产品负责人审批
- [ ] 技术负责人审批
- [ ] QA负责人审批

### 上线审批
- [ ] 产品负责人
- [ ] 技术负责人
- [ ] 运维负责人

---

**注意**: 本需求文档定义了后台管理页面的完整功能和技术实现方案，请严格按照需求进行开发和测试。
