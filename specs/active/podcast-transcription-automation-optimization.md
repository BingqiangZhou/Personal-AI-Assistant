# 播客转录自动化流程优化需求文档

## 基本信息
- **需求ID**: REQ-20241222-001
- **创建日期**: 2024-12-22
- **最后更新**: 2024-12-22
- **负责人**: 产品经理
- **状态**: Active
- **优先级**: High

## 需求描述

### 用户故事
作为播客应用用户，我想要在打开播客分集播放页面时，系统能自动检测并启动转录流程，同时实时显示转录进度，以便我无需手动操作即可获得播客内容的文本转录。

### 业务价值
- **提升用户体验**: 自动化转录流程减少用户手动操作，提升使用便利性
- **增加用户粘性**: 实时进度显示和自动转录功能提升产品吸引力
- **提高内容利用率**: 转录文本便于搜索、分享和内容回顾
- **预期指标**: 转录功能使用率提升60%，用户平均使用时长增加15%

### 背景信息
- **当前状况**: 播客转录功能已实现但需要手动触发，用户体验不够流畅
- **用户痛点**:
  1. 打开播放页面后需要手动点击转录按钮
  2. 转录进度需要用户主动刷新查看
  3. 转录完成后需要手动重新加载页面才能看到结果
- **机会点**: 实现全自动化的转录体验，提供流畅的实时进度反馈

## 功能需求

### 核心功能
- [FR-001] 播放页面打开时自动检测转录状态
- [FR-002] 无转录时自动创建转录任务
- [FR-003] 实时轮询转录进度（每秒更新）
- [FR-004] 转录完成后自动显示结果
- [FR-005] 转录状态实时显示和进度条

### 功能详述

#### 功能1：自动转录状态检测
- **描述**: 当用户进入播客分集播放页面时，系统自动检测该分集是否已有转录
- **输入**: 播客分集ID (episode_id)
- **处理**:
  1. 调用API查询转录状态
  2. 如果无转录记录，自动创建转录任务
  3. 如果有转录记录，检查状态并返回
- **输出**: 转录任务状态和内容

#### 功能2：转录任务自动创建
- **描述**: 当检测到播客分集无转录时，系统自动启动转录流程
- **输入**: 播客分集ID和音频URL
- **处理**:
  1. 创建转录任务记录（status=PENDING）
  2. 启动后台异步任务
  3. 后台执行：下载→转MP3→切割→API转录→合并→保存
- **输出**: 转录任务ID和初始状态

#### 功能3：实时进度轮询
- **描述**: 转录过程中每秒查询一次进度并更新UI
- **输入**: 转录任务ID
- **处理**:
  1. 前端每秒调用轮询API
  2. 显示当前步骤和进度百分比
  3. 转录完成或失败时停止轮询
- **输出**: 实时状态和进度信息

#### 功能4：转录结果展示
- **描述**: 转录完成后自动在页面展示结果
- **输入**: 转录完成的文本内容
- **处理**:
  1. 更新UI显示转录文本
  2. 提供文本搜索和导航功能
  3. 可选显示AI生成摘要
- **输出**: 格式化的转录文本展示

## 用户交互流程

### 完整用户流程
```
1. 用户点击播客分集进入播放页面
   ↓
2. 系统自动检测转录状态
   ├─ 已存在转录：直接显示转录内容
   └─ 无转录：自动创建转录任务
        ↓
3. 显示转录进度（每秒更新）
   ├─ 下载音频中... (5-20%)
   ├─ 转换格式中... (20-35%)
   ├─ 切割文件中... (35-45%)
   ├─ 转录中... (45-95%)
   └─ 合并结果中... (95-100%)
        ↓
4. 转录完成：自动显示转录文本
```

### 错误处理流程
```
转录失败时：
├─ 显示错误信息和重试按钮
├─ 提供"重新转录"选项
└─ 错误信息包含具体失败原因
```

## 技术要求

### 后端实现要求
- 保持现有异步转录架构
- 支持实时状态查询API
- 转录任务状态包含：
  - PENDING（等待开始）
  - DOWNLOADING（下载中 5-20%）
  - CONVERTING（转换中 20-35%）
  - SPLITTING（切割中 35-45%）
  - TRANSCRIBING（转录中 45-95%）
  - MERGING（合并中 95-100%）
  - COMPLETED（完成 100%）
  - FAILED（失败）

### 前端实现要求
- 使用Flutter Riverpod状态管理
- 实现Timer.periodic每秒轮询
- 转录状态使用全局Provider管理
- UI组件：进度条、状态文本、重试按钮
- 支持多分集并发转录状态管理

### API接口要求
现有API已满足需求：
- `POST /api/v1/podcasts/episodes/{episode_id}/transcribe` - 创建转录
- `GET /api/v1/podcasts/episodes/{episode_id}/transcription` - 查询状态

## 当前实现分析

### 已实现功能
✅ **后端转录服务** - 完整的转录流程实现
- PodcastTranscriptionService：核心转录服务
- SiliconFlowTranscriber：多线程并发转录
- 完整的进度跟踪和状态管理
- 支持音频下载、格式转换、文件切割、API转录、结果合并

✅ **前端转录管理** - 基础状态管理
- TranscriptionNotifier：转录状态管理
- 自动轮询机制（每秒更新）
- checkOrStartTranscription方法
- 全局Provider管理多分集转录状态

✅ **API接口** - 完整的REST API
- 创建转录任务接口
- 查询转录状态接口
- 完整的响应模型和错误处理

### 需要优化的部分

#### 1. 前端页面集成
**现状**: 播放页面已有转录状态检测代码
**问题**:
- `PodcastEpisodeDetailPage` 已经实现了自动检测和启动转录
- 但用户描述期望"打开播放页面时自动启动"，实际已经实现
- 可能存在用户认知偏差或流程不够明确

**优化建议**:
- 在页面加载时添加更明显的转录状态提示
- 改进转录进度显示的UI/UX
- 确保转录完成后的自动展示更加流畅

#### 2. 用户认知优化
**现状**: 技术实现基本符合用户期望
**问题**: 用户可能不清楚转录是自动进行的
**解决方案**:
- 在页面加载时显示"正在准备转录..."提示
- 添加转录功能的引导说明
- 优化转录状态的可视化反馈

#### 3. 错误处理和重试
**现状**: 基础错误处理已实现
**优化点**:
- 提供更友好的错误提示
- 添加一键重试功能
- 支持转录失败后的重新启动

## 任务分解

### Frontend优化任务
- [ ] [TASK-F-001] 改进转录启动的用户反馈
  - **负责人**: Frontend Developer
  - **预估工时**: 0.5天
  - **验收标准**:
    - [ ] 页面加载时显示转录检测提示
    - [ ] 自动转录启动时显示明确信息
    - [ ] 转录流程更加透明
  - **状态**: Todo

- [ ] [TASK-F-002] 优化转录进度显示UI
  - **负责人**: Frontend Developer
  - **预估工时**: 1天
  - **验收标准**:
    - [ ] 美化进度条和状态文本
    - [ ] 添加转录步骤的可视化指示
    - [ ] 改进Material 3设计规范实现
  - **状态**: Todo

- [ ] [TASK-F-003] 完善错误处理和重试机制
  - **负责人**: Frontend Developer
  - **预估工时**: 0.5天
  - **验收标准**:
    - [ ] 友好的错误信息展示
    - [ ] 一键重试按钮
    - [ ] 转录失败恢复流程
  - **状态**: Todo

### 测试任务
- [ ] [TASK-T-001] 转录流程端到端测试
  - **负责人**: Test Engineer
  - **预估工时**: 1天
  - **验收标准**:
    - [ ] 自动转录启动测试
    - [ ] 实时进度更新测试
    - [ ] 转录完成展示测试
    - [ ] 错误场景测试
  - **状态**: Todo

- [ ] [TASK-T-002] 转录UI组件测试
  - **负责人**: Test Engineer
  - **预估工时**: 0.5天
  - **验收标准**:
    - [ ] 转录状态Widget测试
    - [ ] 进度条显示测试
    - [ ] 错误处理测试
  - **状态**: Todo

## 验收标准

### 整体验收
- [ ] 用户打开播客分集页面时自动检测转录状态
- [ ] 无转录时自动创建转录任务
- [ ] 转录过程中实时显示进度（每秒更新）
- [ ] 转录完成后自动展示结果
- [ ] 错误处理机制完善

### 用户验收标准
- [ ] 用户无需手动操作即可完成转录
- [ ] 转录进度实时可见且易于理解
- [ ] 转录完成后的展示流畅自然
- [ ] 错误时提供明确的解决路径

### 技术验收标准
- [ ] 代码保持现有架构不变
- [ ] 转录性能无退化
- [ ] UI/UX符合Material 3设计规范
- [ ] 测试覆盖率 > 80%

## 设计约束

### 技术约束
- 必须保持现有的异步转录架构
- 不能修改核心转录服务逻辑
- 保持现有的API接口不变
- 前端必须使用Flutter + Riverpod

### 业务约束
- 转录功能不能影响音频播放性能
- 转录成本控制在合理范围内
- 用户体验优化不能增加系统复杂度

## 风险评估

### 技术风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 前端轮询频率过高影响性能 | 低 | 中 | 优化轮询策略，必要时降频 |
| 转录任务并发过多 | 中 | 中 | 限制同时进行的转录任务数 |
| UI更新影响音频播放 | 低 | 高 | 分离UI更新和音频播放线程 |

### 业务风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 用户不希望自动转录 | 中 | 中 | 提供设置选项关闭自动转录 |
| 转录成本过高 | 中 | 高 | 添加转录提醒和确认机制 |

## 时间线

### 里程碑
- **需求确认**: 2024-12-22
- **设计完成**: 2024-12-22
- **开发完成**: 2024-12-24
- **测试完成**: 2024-12-25
- **上线发布**: 2024-12-26

### 关键路径
1. Frontend优化 (TASK-F-001, TASK-F-002, TASK-F-003)
2. 测试验证 (TASK-T-001, TASK-T-002)
3. 用户验收测试

## 变更记录

| 版本 | 日期 | 变更内容 | 变更人 | 审批人 |
|------|------|----------|--------|--------|
| 1.0 | 2024-12-22 | 初始创建 | 产品经理 | - |

## 相关文档

- [播客转录技术文档](../../../docs/podcast_transcription.md)
- [API接口文档](../../../docs/api.md)
- [UI/UX设计规范](../../../docs/design_system.md)

## 审批

### 需求评审
- [ ] 产品负责人审批
- [ ] 技术负责人审批
- [ ] QA负责人审批

---

**注意**: 本文档分析发现当前实现已基本符合用户期望，主要是UI/UX优化和用户认知改进，开发工作量较小，可快速完成。