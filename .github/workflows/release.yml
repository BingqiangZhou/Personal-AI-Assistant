# Personal AI Assistant - Multi-Platform Release Workflow
# å¤šå¹³å°è‡ªåŠ¨æž„å»ºå¹¶å‘å¸ƒåˆ° GitHub Release
# Triggered by pushing tags matching pattern v*.*.* (e.g., v1.0.0)

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ============================================
  # Job 1: æå–ç‰ˆæœ¬ä¿¡æ¯å’Œç”Ÿæˆæ›´æ–°æ—¥å¿—
  # ============================================
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}
          BUILD_NUMBER=$(echo $VERSION | grep -oE '[0-9]+$' || echo "1")

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

          if [[ $VERSION =~ -(alpha|beta|rc|preview)\.? ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ”¢ Build Number: $BUILD_NUMBER"

      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          {
            echo "## ðŸ“¦ Release v${{ steps.version.outputs.version }}"
            echo ""
            if [ -z "$PREV_TAG" ]; then
              echo "**é¦–æ¬¡å‘å¸ƒ / Initial Release**"
            else
              echo "**Changes since ${PREV_TAG}:**"
              echo ""
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse 2>/dev/null | head -100
            fi
            echo ""
            echo "---"
            echo ""
            echo "**Version:** \`${{ steps.version.outputs.version }}\`"
            echo "**Release Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } > changelog.md

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  # ============================================
  # Job 2: æž„å»º Android APK/AAB
  # ============================================
  build-android:
    name: Build Android
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('frontend/android/**/*.gradle*', 'frontend/android/**/gradle-wrapper.properties', 'frontend/android/**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Pub cache
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Get dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Build APK (Release)
        working-directory: frontend
        run: |
          echo "ðŸ”¨ Building Android APK..."
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            --build-number=${{ needs.prepare-release.outputs.build_number }}

          # é‡å‘½å APK åŒ…å«åº”ç”¨åå’Œç‰ˆæœ¬å·
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/personal-ai-assistant-${{ needs.prepare-release.outputs.version }}-android-arm64.apk

          echo "âœ… APK build completed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: frontend/build/app/outputs/flutter-apk/**/*.apk
          retention-days: 7

  # ============================================
  # Job 3: æž„å»º Windows
  # ============================================
  build-windows:
    name: Build Windows
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Pub cache
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('frontend/**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-${{ hashFiles('frontend/**/pubspec.lock') }}

      - name: Enable Windows desktop
        shell: pwsh
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        working-directory: frontend
        shell: pwsh
        run: flutter pub get

      - name: Build Windows
        working-directory: frontend
        shell: pwsh
        run: |
          Write-Host "ðŸ”¨ Building Windows application..."
          flutter build windows --release --build-number=${{ needs.prepare-release.outputs.build_number }}
          Write-Host "âœ… Windows build completed"

      - name: Create release directory
        working-directory: frontend
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path dist/windows

      - name: Archive Windows release
        working-directory: frontend
        shell: pwsh
        run: |
          $version = "${{ needs.prepare-release.outputs.version }}"
          $sourcePath = "build\windows\x64\runner\Release"
          $destPath = "dist\windows\personal-ai-assistant-windows-$version.zip"
          Compress-Archive -Path "$sourcePath\*" -DestinationPath $destPath -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: frontend/dist/windows/*.zip
          retention-days: 7

  # ============================================
  # Job 4: æž„å»º Linux
  # ============================================
  build-linux:
    name: Build Linux
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Pub cache
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      - name: Install Linux dependencies
        run: |
          echo "ðŸ“¦ Installing Linux build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libglib2.0-dev libpango1.0-dev \
            libatk1.0-dev libcairo-gobject2 libgdk-pixbuf2.0-dev \
            libgraphene-1.0-dev libharfbuzz-dev \
            liblzma-dev libstdc++-12-dev \
            libsecret-1-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
          echo "âœ… Build dependencies installed"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Build Linux
        working-directory: frontend
        run: |
          echo "ðŸ”¨ Building Linux application..."
          flutter build linux \
            --release \
            --build-number=${{ needs.prepare-release.outputs.build_number }}
          echo "âœ… Linux build completed"

      - name: Create release directory
        working-directory: frontend
        run: mkdir -p dist/linux

      - name: Archive Linux release
        working-directory: frontend
        run: |
          tar czf dist/linux/personal-ai-assistant-linux-${{ needs.prepare-release.outputs.version }}.tar.gz \
            -C build/linux/x64/release/bundle .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifact
          path: frontend/dist/linux/*.tar.gz
          retention-days: 7

  # ============================================
  # Job 5: æž„å»º macOS
  # ============================================
  build-macos:
    name: Build macOS
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Pub cache
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Get dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Build macOS
        working-directory: frontend
        run: |
          echo "ðŸ”¨ Building macOS application..."
          flutter build macos \
            --release \
            --build-number=${{ needs.prepare-release.outputs.build_number }}
          echo "âœ… macOS build completed"

      - name: Create release directory
        working-directory: frontend
        run: mkdir -p dist/macos

      - name: Archive macOS release
        working-directory: frontend
        run: |
          zip -r "dist/macos/personal-ai-assistant-macos-${{ needs.prepare-release.outputs.version }}.zip" \
            -C build/macos/Build/Products/Release *.app

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifact
          path: frontend/dist/macos/*.zip
          retention-days: 7

  # ============================================
  # Job 6: å‘å¸ƒåˆ° GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs:
      - prepare-release
      - build-android
      - build-windows
      - build-linux
      - build-macos
    runs-on: ubuntu-latest
    if: always() &&
        needs.prepare-release.result == 'success' &&
        needs.build-android.result == 'success' &&
        needs.build-windows.result == 'success' &&
        needs.build-linux.result == 'success' &&
        needs.build-macos.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts structure
        run: |
          echo "ðŸ“ Downloaded artifacts:"
          find artifacts -type f | sort

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          name: Personal AI Assistant v${{ needs.prepare-release.outputs.version }}
          body_path: changelog.md
          draft: false
          prerelease: ${{ needs.prepare-release.outputs.is_prerelease }}
          files: |
            artifacts/android-artifacts/**/*.apk
            artifacts/windows-artifact/**/*.zip
            artifacts/linux-artifact/**/*.tar.gz
            artifacts/macos-artifact/**/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "### âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease:** ${{ needs.prepare-release.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Released Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Android APK" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows Executable" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux Binary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ macOS Application" >> $GITHUB_STEP_SUMMARY
