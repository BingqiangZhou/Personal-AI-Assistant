# Alembic Database Migrations

This directory contains database migration scripts for the Personal AI Assistant backend.

## Overview

Alembic is a database migration tool for SQLAlchemy. This project uses Alembic to manage database schema changes over time.

## Running Migrations

### Inside Docker container (Recommended for production)

```bash
docker exec <container_name> uv run alembic upgrade head
```

Example:
```bash
docker exec personal_ai_backend uv run alembic upgrade head
```

### Local development

```bash
cd backend
uv run alembic upgrade head
```

## Migration History

| Revision | Description | Date |
|----------|-------------|------|
| `001_create_podcast_tables` | Initial podcast tables creation | - |
| `002_add_episode_image_field` | Add image_url field to podcast_episodes | - |
| `003_add_transcription_task_summary_columns` | Add summary columns to transcription tasks | - |
| `004_add_current_step_to_transcription_tasks` | Add current_step tracking | - |
| `005_increase_api_key_column_size` | Increase API key column size | - |
| `007_add_podcast_conversations_table` | Add podcast conversations table | - |
| `008_add_subscription_schedule_fields` | Add RSS subscription scheduling fields | - |
| `009_add_download_method_to_transcription_tasks` | Add download method field | - |
| `010_add_episode_item_link` | Add item_link to episodes | - |
| `011_remove_download_method` | Remove download method field | - |
| `012_add_admin_audit_log_table` | Add admin audit logging | - |
| `013_add_2fa_fields_to_users_table` | Add two-factor authentication fields | - |
| `014_add_priority_to_ai_model_configs` | Add priority to AI model configs | - |
| `015_add_system_settings_table` | Add system settings table | - |
| `016_remove_guid_use_item_link_as_unique` | Remove guid, use item_link as unique | - |
| `017_add_subscription_title_index` | Add index on subscription title | - |
| `018_cascade_delete_podcast_fk` | Add CASCADE DELETE to podcast foreign keys | 2026-01-14 |
| `019_add_latest_item_published_at` | Add latest_item_published_at to subscriptions | 2026-01-17 |

## Recent Changes

### 019_add_latest_item_published_at (2026-01-17)

**Purpose**: Track the latest content publish time from RSS feeds.

**Changes**:
- Added `latest_item_published_at` column to `subscriptions` table
- This field stores the published timestamp of the latest item from the feed
- Different from `last_fetched_at` which tracks when we last checked the feed

**Data Flow**:
1. RSS feed is fetched and parsed
2. For each entry, `entry.published_at` is extracted
3. The maximum `published_at` across all entries is stored in `latest_item_published_at`
4. This is updated on every successful fetch

**Schema**:
```sql
ALTER TABLE subscriptions ADD COLUMN latest_item_published_at TIMESTAMP;
```

### 018_cascade_delete_podcast_fk (2026-01-14)

**Purpose**: Fix cascade delete behavior for podcast-related tables.

**Changes**:
- Added `ON DELETE CASCADE` to foreign keys in:
  - `podcast_playback_states.episode_id`
  - `transcription_tasks.episode_id`
  - `podcast_conversations.episode_id`

## Creating New Migrations

When making database schema changes:

1. Modify the model in `app/domains/*/models.py`
2. Generate a new migration:
   ```bash
   uv run alembic revision --autogenerate -m "description_of_changes"
   ```
3. Review the generated migration file in `alembic/versions/`
4. Apply the migration:
   ```bash
   uv run alembic upgrade head
   ```

## Rolling Back

To rollback to a previous revision:
```bash
uv run alembic downgrade <revision_id>
```

To rollback one step:
```bash
uv run alembic downgrade -1
```

## Checking Current Status

```bash
# Show current revision
uv run alembic current

# Show migration history
uv run alembic history

# Show pending migrations
uv run alembic heads
```

## Best Practices

1. **Always review** auto-generated migrations before applying
2. **Write both upgrade and downgrade** functions for reversibility
3. **Test migrations** in development before production
4. **Never modify** existing migration files - create new ones instead
5. **Commit migrations** with your code changes

## Troubleshooting

### Migration conflicts in team development

If multiple developers create migrations with the same revision number:

1. Identify the conflict: `uv run alembic heads`
2. Create a merge migration: `uv run alembic merge -m "merge migrations" <rev1> <rev2>`
3. Apply the merge: `uv run alembic upgrade head`

### Database out of sync

If the database schema doesn't match the expected state:

1. Check current revision: `uv run alembic current`
2. Stamp the database to the correct revision: `uv run alembic stamp <revision>`
3. Then run migrations normally

## Notes

- This project uses PostgreSQL with asyncpg driver
- All migrations run within transactions (rollback on error)
- Migration files use the naming convention: `<number>_<description>.py`
