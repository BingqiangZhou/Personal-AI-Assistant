{% extends "base.html" %}

{% block title %}系统监控{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-start sm:justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">系统监控</h1>
            <p class="mt-2 text-sm text-gray-700">
                关键指标包括 API 延迟、错误率、缓存命中率、数据库连接池占用和 Redis 命令耗时。
            </p>
        </div>
        <div class="mt-4 sm:mt-0 flex items-center gap-2">
            <label for="refresh-interval" class="text-sm text-gray-700">自动刷新</label>
            <select id="refresh-interval" class="rounded-md border-gray-300 text-sm">
                <option value="0">关闭</option>
                <option value="10000">10秒</option>
                <option value="30000" selected>30秒</option>
                <option value="60000">60秒</option>
            </select>
            <button
                id="refresh-btn"
                class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white hover:bg-indigo-700"
                type="button"
            >
                立即刷新
            </button>
        </div>
    </div>

    <div id="status-banner" class="mt-4 rounded-md border border-gray-200 bg-white p-4 text-sm text-gray-700">
        等待首次加载...
    </div>

    <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5">
        <div class="rounded-lg bg-white p-4 shadow">
            <p class="text-xs text-gray-500">API P95 (ms)</p>
            <p id="metric-api-p95" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
        </div>
        <div class="rounded-lg bg-white p-4 shadow">
            <p class="text-xs text-gray-500">错误率</p>
            <p id="metric-error-rate" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
        </div>
        <div class="rounded-lg bg-white p-4 shadow">
            <p class="text-xs text-gray-500">Redis 命中率</p>
            <p id="metric-cache-hit-rate" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
        </div>
        <div class="rounded-lg bg-white p-4 shadow">
            <p class="text-xs text-gray-500">DB 池占用</p>
            <p id="metric-db-occupancy" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
        </div>
        <div class="rounded-lg bg-white p-4 shadow">
            <p class="text-xs text-gray-500">Redis 平均耗时 (ms)</p>
            <p id="metric-redis-avg" class="mt-1 text-2xl font-semibold text-gray-900">-</p>
        </div>
    </div>

    <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div class="rounded-lg bg-white p-4 shadow">
            <h2 class="text-sm font-semibold text-gray-900">主机信息</h2>
            <dl class="mt-3 grid grid-cols-2 gap-2 text-sm">
                <dt class="text-gray-500">Hostname</dt>
                <dd id="sys-hostname" class="text-gray-900">-</dd>
                <dt class="text-gray-500">OS</dt>
                <dd id="sys-os" class="text-gray-900">-</dd>
                <dt class="text-gray-500">运行时长</dt>
                <dd id="sys-uptime" class="text-gray-900">-</dd>
                <dt class="text-gray-500">用户数</dt>
                <dd id="sys-users" class="text-gray-900">-</dd>
            </dl>
        </div>
        <div class="rounded-lg bg-white p-4 shadow">
            <h2 class="text-sm font-semibold text-gray-900">资源概览</h2>
            <dl class="mt-3 grid grid-cols-2 gap-2 text-sm">
                <dt class="text-gray-500">CPU 使用率</dt>
                <dd id="cpu-usage" class="text-gray-900">-</dd>
                <dt class="text-gray-500">内存使用率</dt>
                <dd id="mem-usage" class="text-gray-900">-</dd>
                <dt class="text-gray-500">磁盘读写 (bytes)</dt>
                <dd id="disk-io" class="text-gray-900">-</dd>
                <dt class="text-gray-500">网络收发 (bytes)</dt>
                <dd id="net-io" class="text-gray-900">-</dd>
            </dl>
        </div>
    </div>

    <div class="mt-6 rounded-lg bg-white p-4 shadow">
        <h2 class="text-sm font-semibold text-gray-900">告警检查</h2>
        <div class="mt-3 overflow-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left font-medium text-gray-500">检查项</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500">状态</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500">当前值</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500">阈值</th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500">说明</th>
                    </tr>
                </thead>
                <tbody id="checks-table" class="divide-y divide-gray-100 bg-white">
                    <tr><td class="px-3 py-2 text-gray-500" colspan="5">等待数据...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const endpoint = '/super/api/monitoring/all';
    const statusBanner = document.getElementById('status-banner');
    const refreshButton = document.getElementById('refresh-btn');
    const refreshSelect = document.getElementById('refresh-interval');
    let refreshTimer = null;

    const pct = (v) => `${(Number(v || 0) * 100).toFixed(2)}%`;
    const ms = (v) => Number(v || 0).toFixed(2);

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = value;
        }
    };

    const statusClass = (status) => {
        if (status === 'critical') return 'text-red-700 bg-red-100';
        if (status === 'warning') return 'text-amber-700 bg-amber-100';
        return 'text-green-700 bg-green-100';
    };

    const renderChecks = (checks) => {
        const body = document.getElementById('checks-table');
        if (!body) return;
        if (!checks || checks.length === 0) {
            body.innerHTML = '<tr><td class="px-3 py-2 text-gray-500" colspan="5">暂无检查项</td></tr>';
            return;
        }

        body.innerHTML = checks.map((item) => `
            <tr>
                <td class="px-3 py-2 text-gray-900">${item.name}</td>
                <td class="px-3 py-2">
                    <span class="inline-flex rounded px-2 py-1 text-xs font-medium ${statusClass(item.status)}">
                        ${item.status}
                    </span>
                </td>
                <td class="px-3 py-2 text-gray-900">${Number(item.value).toFixed(4)} ${item.unit || ''}</td>
                <td class="px-3 py-2 text-gray-900">${Number(item.threshold).toFixed(4)} ${item.unit || ''}</td>
                <td class="px-3 py-2 text-gray-600">${item.message}</td>
            </tr>
        `).join('');
    };

    const render = (data) => {
        const runtime = data.runtime || {};
        const obs = runtime.observability || {};
        const summary = obs.summary || {};
        const systemInfo = data.system_info || {};
        const cpu = data.cpu || {};
        const memory = data.memory || {};
        const disk = data.disk || {};
        const net = data.network || {};

        setText('metric-api-p95', ms(summary.api_p95_ms));
        setText('metric-error-rate', pct(summary.api_error_rate));
        setText('metric-cache-hit-rate', pct(summary.redis_cache_hit_rate));
        setText('metric-db-occupancy', pct(summary.db_pool_occupancy_ratio));
        setText('metric-redis-avg', ms(summary.redis_command_avg_ms));

        setText('sys-hostname', systemInfo.hostname || '-');
        setText('sys-os', `${systemInfo.os_type || '-'} ${systemInfo.os_version || ''}`);
        setText('sys-uptime', `${Math.floor((systemInfo.uptime_seconds || 0) / 60)} 分钟`);
        setText('sys-users', String(systemInfo.current_users || 0));

        setText('cpu-usage', `${Number(cpu.usage_percent || 0).toFixed(2)}%`);
        setText('mem-usage', `${Number(memory.percent || 0).toFixed(2)}%`);
        setText('disk-io', `${disk.read_bytes || 0} / ${disk.write_bytes || 0}`);
        const interfaces = (net.interfaces || []);
        const totalSent = interfaces.reduce((sum, i) => sum + Number(i.bytes_sent || 0), 0);
        const totalRecv = interfaces.reduce((sum, i) => sum + Number(i.bytes_recv || 0), 0);
        setText('net-io', `${totalSent} / ${totalRecv}`);

        const overall = summary.overall_status || 'ok';
        statusBanner.className = `mt-4 rounded-md border p-4 text-sm ${statusClass(overall)}`;
        statusBanner.textContent = `整体状态: ${overall} | 告警数: ${summary.alerts_count || 0} | 更新时间: ${obs.generated_at || '-'}`;
        renderChecks(obs.checks || []);
    };

    const fetchMetrics = async () => {
        try {
            const response = await fetch(endpoint, { credentials: 'same-origin' });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const payload = await response.json();
            render(payload);
        } catch (error) {
            statusBanner.className = 'mt-4 rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700';
            statusBanner.textContent = `加载失败: ${error.message}`;
        }
    };

    const resetTimer = () => {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        const interval = Number(refreshSelect.value);
        if (interval > 0) {
            refreshTimer = setInterval(fetchMetrics, interval);
        }
    };

    refreshButton.addEventListener('click', fetchMetrics);
    refreshSelect.addEventListener('change', resetTimer);

    fetchMetrics();
    resetTimer();
})();
</script>
{% endblock %}

