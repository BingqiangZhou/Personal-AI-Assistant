{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½®{% endblock %}

{% block extra_head %}
<style>
    /* Range slider styling */
    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        margin-top: -8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
    }

    input[type=range]::-moz-range-thumb {
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type=range]::-moz-range-track {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
    }

    input[type=range]:focus {
        outline: none;
    }

    input[type=range]:focus::-webkit-slider-runnable-track {
        background: #d1d5db;
    }

    /* Value display styling */
    .value-display {
        min-width: 60px;
        text-align: center;
        padding: 8px 16px;
        background: #f3f4f6;
        border-radius: 8px;
        font-weight: 600;
        color: #4f46e5;
        font-size: 16px;
    }

    /* Card title styling */
    .card-subtitle {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .card-description {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 16px;
    }

    /* Header save button */
    .header-save-btn {
        transition: all 0.2s ease;
    }

    .header-save-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .header-save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Success message */
    .save-success {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Loading spinner */
    .spinner {
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="py-4">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
            ç³»ç»Ÿè®¾ç½®
        </h2>
    </div>

    <!-- Audio Processing Settings Card -->
    <div class="mt-6 bg-white shadow sm:rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">éŸ³é¢‘å¤„ç†</h3>
            <button
                type="button"
                onclick="saveAudioSettings()"
                id="audio-save-btn"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                ä¿å­˜
            </button>
        </div>
        <div class="px-6 py-6 space-y-8">
            <!-- Audio Chunk Size -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="card-subtitle whitespace-nowrap">éŸ³é¢‘åˆ‡å—å¤§å°</div>
                    <div class="flex-1"></div>
                    <input
                        type="range"
                        id="chunk-size"
                        name="chunk_size_mb"
                        min="5"
                        max="25"
                        value="10"
                        step="1"
                        style="width: 120px;"
                    >
                    <div class="flex items-center gap-2 ml-4">
                        <div id="chunk-size-value" class="value-display" style="min-width: 50px; padding: 6px 12px;">10</div>
                        <span class="text-sm text-gray-500 w-8">MB</span>
                    </div>
                </div>
                <p class="card-description">è¾ƒå¤§çš„å€¼å¯æé«˜å¤„ç†é€Ÿåº¦ï¼Œä½†ä¼šå¢åŠ å†…å­˜ä½¿ç”¨</p>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200"></div>

            <!-- Max Concurrent Threads -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="card-subtitle whitespace-nowrap">æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°</div>
                    <div class="flex-1"></div>
                    <input
                        type="range"
                        id="max-threads"
                        name="max_concurrent_threads"
                        min="1"
                        max="16"
                        value="4"
                        step="1"
                        style="width: 120px;"
                    >
                    <div class="flex items-center gap-2 ml-4">
                        <div id="max-threads-value" class="value-display" style="min-width: 50px; padding: 6px 12px;">4</div>
                        <span class="text-sm text-gray-500 w-8">ä¸ª</span>
                    </div>
                </div>
                <p class="card-description">é«˜å¹¶å‘å¯åŠ å¿«å¤„ç†é€Ÿåº¦ï¼Œä½†ä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½</p>
            </div>
        </div>
    </div>

    <!-- RSS Subscription Settings Card -->
    <div class="mt-6 bg-white shadow sm:rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">RSSè®¢é˜…è®¾ç½®</h3>
            <button
                type="button"
                onclick="saveFrequencySettings()"
                id="rss-save-btn"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                ä¿å­˜
            </button>
        </div>
        <div class="px-6 py-6 space-y-6">
            <!-- Update Frequency -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div class="card-subtitle">æ›´æ–°é¢‘ç‡</div>
                    <select id="update-frequency" name="update_frequency"
                            class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3 border">
                        <option value="HOURLY">æ¯å°æ—¶</option>
                        <option value="DAILY">æ¯å¤©</option>
                        <option value="WEEKLY">æ¯å‘¨</option>
                    </select>
                </div>
                <p class="card-description">è®¾ç½®é»˜è®¤åˆ·æ–°é¢‘ç‡</p>
            </div>

            <!-- Conditional Time Setting (for DAILY and WEEKLY) -->
            <div id="daily-time-setting" class="space-y-3" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="card-subtitle">æ›´æ–°æ—¶é—´</div>
                    <input type="time" id="update-time" name="update_time" value="00:00"
                           class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3 border">
                </div>
            </div>

            <!-- Conditional Day Setting (for WEEKLY only) -->
            <div id="weekly-day-setting" class="space-y-3" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="card-subtitle">æ˜ŸæœŸ</div>
                    <select id="update-day" name="update_day"
                            class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3 border">
                        <option value="1">å‘¨ä¸€</option>
                        <option value="2">å‘¨äºŒ</option>
                        <option value="3">å‘¨ä¸‰</option>
                        <option value="4">å‘¨å››</option>
                        <option value="5">å‘¨äº”</option>
                        <option value="6">å‘¨å…­</option>
                        <option value="7">å‘¨æ—¥</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Settings Card -->
    <div class="mt-6 mb-8 bg-white shadow sm:rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">å®‰å…¨è®¾ç½®</h3>
        </div>
        <div class="px-6 py-6 space-y-6">
            <!-- 2FA Toggle -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="card-subtitle">åŒå› ç´ è®¤è¯ (2FA)</div>
                        <p class="card-description mt-1">å¯ç”¨åï¼Œç™»å½•åå°ç®¡ç†éœ€è¦éªŒè¯ä¸¤æ­¥è®¤è¯ç </p>
                    </div>
                    <div class="flex items-center">
                        <button
                            type="button"
                            id="2fa-toggle"
                            onclick="toggleAndSave2FA()"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                            role="switch"
                            aria-checked="true"
                        >
                            <span
                                aria-hidden="true"
                                id="2fa-toggle-knob"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                            ></span>
                        </button>
                    </div>
                </div>
                <div id="2fa-status" class="text-sm text-gray-500">
                    å½“å‰çŠ¶æ€: <span id="2fa-status-text">å¯ç”¨</span>
                    <span id="2fa-source" class="text-xs text-gray-400 ml-2">(æ¥æº: æ•°æ®åº“)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Management Card -->
    <div class="mt-6 bg-white shadow sm:rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">å­˜å‚¨ç®¡ç†</h3>
            <button
                type="button"
                onclick="loadStorageInfo()"
                id="storage-refresh-btn"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                åˆ·æ–°
            </button>
        </div>
        <div class="px-6 py-6 space-y-6">
            <!-- Storage Directory Info -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="card-subtitle whitespace-nowrap">ğŸ“ Storage ç›®å½•</div>
                    <div class="flex-1"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">æ–‡ä»¶æ•°:</span>
                        <span id="storage-file-count" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                    <div>
                        <span class="text-gray-500">å¤§å°:</span>
                        <span id="storage-size" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200"></div>

            <!-- Temp Directory Info -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="card-subtitle whitespace-nowrap">ğŸ“ Temp ç›®å½•</div>
                    <div class="flex-1"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">æ–‡ä»¶æ•°:</span>
                        <span id="temp-file-count" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                    <div>
                        <span class="text-gray-500">å¤§å°:</span>
                        <span id="temp-size" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200"></div>

            <!-- Disk Usage Info -->
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="card-subtitle whitespace-nowrap">ğŸ’¾ ç³»ç»Ÿç£ç›˜</div>
                    <div class="flex-1"></div>
                </div>
                <div class="space-y-2">
                    <div class="text-sm">
                        <span class="text-gray-500">å‰©ä½™:</span>
                        <span id="disk-free" class="ml-2 font-semibold text-gray-900">-</span>
                        <span class="text-gray-500"> / </span>
                        <span id="disk-total" class="font-semibold text-gray-900">-</span>
                        <span id="disk-usage-percent" class="ml-2 px-2 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-600">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="disk-usage-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200"></div>

            <!-- Auto Cleanup Toggle -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="card-subtitle">è‡ªåŠ¨æ¸…ç†ç¼“å­˜</div>
                        <p class="card-description mt-1">æ¯å¤©å‡Œæ™¨4ç‚¹æ¸…ç†æ˜¨å¤©åŠä¹‹å‰çš„æ–‡ä»¶</p>
                    </div>
                    <div class="flex items-center">
                        <button
                            type="button"
                            id="auto-cleanup-toggle"
                            onclick="toggleAutoCleanup()"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                            role="switch"
                            aria-checked="false"
                        >
                            <span
                                aria-hidden="true"
                                id="auto-cleanup-toggle-knob"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                            ></span>
                        </button>
                    </div>
                </div>
                <div id="auto-cleanup-status" class="text-sm text-gray-500">
                    å½“å‰çŠ¶æ€: <span id="auto-cleanup-status-text">ç¦ç”¨</span>
                    <span id="auto-cleanup-last-run" class="text-xs text-gray-400 ml-2"></span>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200"></div>

            <!-- Manual Cleanup Button -->
            <div class="space-y-3">
                <div class="card-subtitle">æ‰‹åŠ¨æ¸…ç†</div>
                <p class="card-description">ç«‹å³æ¸…ç†æ˜¨å¤©åŠä¹‹å‰çš„æ–‡ä»¶</p>
                <button
                    type="button"
                    id="manual-cleanup-btn"
                    onclick="executeManualCleanup()"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
                >
                    ç«‹å³æ¸…ç†
                </button>
            </div>
        </div>
    </div>

    <!-- System Info Card -->
    <div class="mt-6 mb-8 bg-white shadow sm:rounded-lg overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">ç³»ç»Ÿä¿¡æ¯</h3>
        </div>
        <div class="px-6 py-5">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                <div>
                    <dt class="text-sm font-medium text-gray-500">ç³»ç»Ÿç‰ˆæœ¬</dt>
                    <dd class="mt-1 text-sm text-gray-900">1.0.0</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">æ•°æ®åº“çŠ¶æ€</dt>
                    <dd class="mt-1 text-sm text-green-600">æ­£å¸¸</dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- Success/Error Message Container -->
<div id="message-container"></div>

<script>
    // Get DOM elements
    const chunkSizeSlider = document.getElementById('chunk-size');
    const chunkSizeValue = document.getElementById('chunk-size-value');
    const maxThreadsSlider = document.getElementById('max-threads');
    const maxThreadsValue = document.getElementById('max-threads-value');
    const frequencySelect = document.getElementById('update-frequency');
    const dailyTimeSetting = document.getElementById('daily-time-setting');
    const weeklyDaySetting = document.getElementById('weekly-day-setting');
    const messageContainer = document.getElementById('message-container');

    // 2FA Toggle elements
    const twoFaToggle = document.getElementById('2fa-toggle');
    const twoFaToggleKnob = document.getElementById('2fa-toggle-knob');
    const twoFaStatusText = document.getElementById('2fa-status-text');
    const twoFaSource = document.getElementById('2fa-source');

    // Store original values to detect changes
    let originalValues = {
        chunkSize: 10,
        maxThreads: 4,
        frequency: 'HOURLY',
        updateTime: '00:00',
        updateDay: '1',
        twoFaEnabled: true
    };

    // Current 2FA state
    let current2FAState = {
        enabled: true,
        source: 'database'
    };

    // Toggle 2FA switch (no longer used, replaced by toggleAndSave2FA)
    function toggle2FA() {
        current2FAState.enabled = !current2FAState.enabled;
        update2FAUI();
    }

    // Toggle 2FA and immediately save
    async function toggleAndSave2FA() {
        // Show loading state
        const originalEnabled = current2FAState.enabled;
        const newEnabled = !originalEnabled;

        // Optimistically update UI
        current2FAState.enabled = newEnabled;
        update2FAUI();

        // Show saving indicator
        twoFaStatusText.textContent = newEnabled ? 'å¯ç”¨ä¸­...' : 'ç¦ç”¨ä¸­...';

        try {
            const response = await fetch('/super/settings/api/security', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    admin_2fa_enabled: newEnabled,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                // Update original value and show success message
                originalValues.twoFaEnabled = newEnabled;
                current2FAState.source = 'database';
                update2FAUI();

                // Show success message
                const statusText = newEnabled ? 'åŒå› ç´ è®¤è¯å·²å¯ç”¨' : 'åŒå› ç´ è®¤è¯å·²ç¦ç”¨';
                showMessage(statusText + 'ï¼');
            } else {
                // Revert to original value on error
                current2FAState.enabled = originalEnabled;
                update2FAUI();
                showMessage('ä¿å­˜å¤±è´¥: ' + (data.detail || data.message || 'æœªçŸ¥é”™è¯¯'), false);
            }
        } catch (error) {
            console.error('Error:', error);
            // Revert to original value
            current2FAState.enabled = originalEnabled;
            update2FAUI();
            showMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        }
    }

    // Update 2FA UI based on state
    function update2FAUI() {
        const enabled = current2FAState.enabled;

        if (enabled) {
            twoFaToggle.classList.remove('bg-gray-200');
            twoFaToggle.classList.add('bg-indigo-600');
            twoFaToggleKnob.classList.remove('translate-x-0');
            twoFaToggleKnob.classList.add('translate-x-5');
            twoFaStatusText.textContent = 'å¯ç”¨';
            twoFaStatusText.classList.remove('text-red-600');
            twoFaStatusText.classList.add('text-green-600');
        } else {
            twoFaToggle.classList.remove('bg-indigo-600');
            twoFaToggle.classList.add('bg-gray-200');
            twoFaToggleKnob.classList.remove('translate-x-5');
            twoFaToggleKnob.classList.add('translate-x-0');
            twoFaStatusText.textContent = 'ç¦ç”¨';
            twoFaStatusText.classList.remove('text-green-600');
            twoFaStatusText.classList.add('text-red-600');
        }

        // Update source text
        const sourceText = current2FAState.source === 'database' ? 'æ•°æ®åº“' : 'ç¯å¢ƒå˜é‡';
        twoFaSource.textContent = `(æ¥æº: ${sourceText})`;
    }

    // Show/hide time and day fields based on frequency
    function updateFrequencyFields() {
        const frequency = frequencySelect.value;
        if (frequency === 'HOURLY') {
            dailyTimeSetting.style.display = 'none';
            weeklyDaySetting.style.display = 'none';
        } else if (frequency === 'DAILY') {
            dailyTimeSetting.style.display = 'block';
            weeklyDaySetting.style.display = 'none';
        } else if (frequency === 'WEEKLY') {
            dailyTimeSetting.style.display = 'block';
            weeklyDaySetting.style.display = 'block';
        }
    }

    // Save frequency settings
    async function saveFrequencySettings() {
        const saveBtn = document.getElementById('rss-save-btn');

        // Disable button and show loading
        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­...';

        try {
            const frequencyData = {
                update_frequency: frequencySelect.value
            };

            if (frequencySelect.value === 'DAILY' || frequencySelect.value === 'WEEKLY') {
                frequencyData.update_time = document.getElementById('update-time').value;
            }
            if (frequencySelect.value === 'WEEKLY') {
                // Backend expects 'update_day', not 'update_day_of_week'
                frequencyData.update_day = parseInt(document.getElementById('update-day').value);
            }

            const response = await fetch('/super/settings/frequency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(frequencyData),
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(data.message || 'RSSè®¢é˜…è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼');
                // Update original values
                originalValues.frequency = frequencySelect.value;
                originalValues.updateTime = document.getElementById('update-time').value;
                originalValues.updateDay = document.getElementById('update-day').value;
            } else {
                showMessage('ä¿å­˜å¤±è´¥: ' + (data.detail || data.message || 'æœªçŸ¥é”™è¯¯'), false);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        } finally {
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }

    // Show success/error message
    function showMessage(message, isSuccess = true) {
        const messageEl = document.createElement('div');
        messageEl.className = 'save-success';
        messageEl.style.background = isSuccess ? '#10b981' : '#ef4444';
        messageEl.textContent = message;
        messageContainer.appendChild(messageEl);

        setTimeout(() => {
            messageEl.remove();
        }, 3000);
    }

    // Check if there are unsaved changes
    function hasChanges() {
        return chunkSizeSlider.value != originalValues.chunkSize ||
               maxThreadsSlider.value != originalValues.maxThreads ||
               frequencySelect.value != originalValues.frequency ||
               document.getElementById('update-time').value != originalValues.updateTime ||
               document.getElementById('update-day').value != originalValues.updateDay;
    }

    // Load current settings on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Load audio settings
        try {
            const response = await fetch('/super/settings/api/audio');
            if (response.ok) {
                const data = await response.json();
                if (data.chunk_size_mb !== undefined) {
                    chunkSizeSlider.value = data.chunk_size_mb;
                    chunkSizeValue.textContent = data.chunk_size_mb;
                    originalValues.chunkSize = data.chunk_size_mb;
                }
                if (data.max_concurrent_threads !== undefined) {
                    maxThreadsSlider.value = data.max_concurrent_threads;
                    maxThreadsValue.textContent = data.max_concurrent_threads;
                    originalValues.maxThreads = data.max_concurrent_threads;
                }
            }
        } catch (error) {
            console.error('Failed to load audio settings:', error);
        }

        // Load frequency settings
        try {
            const freqResponse = await fetch('/super/settings/frequency');
            if (freqResponse.ok) {
                const freqData = await freqResponse.json();
                if (freqData.update_frequency) {
                    frequencySelect.value = freqData.update_frequency;
                    originalValues.frequency = freqData.update_frequency;
                }
                if (freqData.update_time) {
                    document.getElementById('update-time').value = freqData.update_time;
                    originalValues.updateTime = freqData.update_time;
                }
                if (freqData.update_day_of_week) {
                    document.getElementById('update-day').value = freqData.update_day_of_week;
                    originalValues.updateDay = freqData.update_day_of_week;
                }
                updateFrequencyFields();
            }
        } catch (error) {
            console.error('Failed to load frequency settings:', error);
        }

        // Load security settings (2FA)
        try {
            const securityResponse = await fetch('/super/settings/api/security');
            if (securityResponse.ok) {
                const securityData = await securityResponse.json();
                current2FAState.enabled = securityData.admin_2fa_enabled;
                current2FAState.source = securityData.source;
                originalValues.twoFaEnabled = securityData.admin_2fa_enabled;
                update2FAUI();
            }
        } catch (error) {
            console.error('Failed to load security settings:', error);
        }
    });

    // Update display when slider moves
    chunkSizeSlider.addEventListener('input', function() {
        chunkSizeValue.textContent = this.value;
    });

    maxThreadsSlider.addEventListener('input', function() {
        maxThreadsValue.textContent = this.value;
    });

    // Handle frequency change
    frequencySelect.addEventListener('change', updateFrequencyFields);

    // Save audio settings only
    async function saveAudioSettings() {
        const saveBtn = document.getElementById('audio-save-btn');

        // Disable button and show loading
        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­...';

        try {
            const response = await fetch('/super/settings/api/audio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chunk_size_mb: parseInt(chunkSizeSlider.value),
                    max_concurrent_threads: parseInt(maxThreadsSlider.value),
                }),
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('éŸ³é¢‘è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼');
                // Update original values
                originalValues.chunkSize = chunkSizeSlider.value;
                originalValues.maxThreads = maxThreadsSlider.value;
            } else {
                showMessage('ä¿å­˜å¤±è´¥: ' + (data.detail || data.message || 'æœªçŸ¥é”™è¯¯'), false);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        } finally {
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }

    // ==================== Storage Management Functions ====================

    // Auto cleanup state
    let autoCleanupState = {
        enabled: false,
        lastCleanup: null
    };

    // Load storage information
    async function loadStorageInfo() {
        const refreshBtn = document.getElementById('storage-refresh-btn');
        const originalText = refreshBtn.textContent;
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span class="spinner"></span> åŠ è½½ä¸­...';

        try {
            const response = await fetch('/super/settings/api/storage/info');
            if (response.ok) {
                const data = await response.json();
                updateStorageUI(data);
            } else {
                showMessage('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥', false);
            }
        } catch (error) {
            console.error('Failed to load storage info:', error);
            showMessage('åŠ è½½å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        } finally {
            refreshBtn.disabled = false;
            refreshBtn.textContent = originalText;
        }
    }

    // Update storage UI with data
    function updateStorageUI(data) {
        // Update storage directory info
        if (data.storage) {
            document.getElementById('storage-file-count').textContent = data.storage.file_count.toLocaleString();
            document.getElementById('storage-size').textContent = data.storage.total_size_human;
        }

        // Update temp directory info
        if (data.temp) {
            document.getElementById('temp-file-count').textContent = data.temp.file_count.toLocaleString();
            document.getElementById('temp-size').textContent = data.temp.total_size_human;
        }

        // Update disk usage info
        if (data.disk) {
            document.getElementById('disk-free').textContent = data.disk.free_human;
            document.getElementById('disk-total').textContent = data.disk.total_human;
            document.getElementById('disk-usage-percent').textContent = data.disk.usage_percent + '%';
            document.getElementById('disk-usage-bar').style.width = data.disk.usage_percent + '%';

            // Update progress bar color based on usage
            const usageBar = document.getElementById('disk-usage-bar');
            if (data.disk.usage_percent > 90) {
                usageBar.classList.remove('bg-indigo-600', 'bg-yellow-500');
                usageBar.classList.add('bg-red-600');
            } else if (data.disk.usage_percent > 70) {
                usageBar.classList.remove('bg-indigo-600', 'bg-red-600');
                usageBar.classList.add('bg-yellow-500');
            } else {
                usageBar.classList.remove('bg-red-600', 'bg-yellow-500');
                usageBar.classList.add('bg-indigo-600');
            }
        }
    }

    // Toggle auto cleanup
    async function toggleAutoCleanup() {
        const originalEnabled = autoCleanupState.enabled;
        const newEnabled = !originalEnabled;

        // Optimistically update UI
        autoCleanupState.enabled = newEnabled;
        updateAutoCleanupUI();

        try {
            const response = await fetch('/super/settings/api/storage/cleanup/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    enabled: newEnabled,
                }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMessage(data.message || 'é…ç½®å·²æ›´æ–°ï¼');
            } else {
                // Revert on error
                autoCleanupState.enabled = originalEnabled;
                updateAutoCleanupUI();
                showMessage('ä¿å­˜å¤±è´¥: ' + (data.detail || data.message || 'æœªçŸ¥é”™è¯¯'), false);
            }
        } catch (error) {
            console.error('Error:', error);
            // Revert on error
            autoCleanupState.enabled = originalEnabled;
            updateAutoCleanupUI();
            showMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        }
    }

    // Update auto cleanup UI
    function updateAutoCleanupUI() {
        const toggle = document.getElementById('auto-cleanup-toggle');
        const knob = document.getElementById('auto-cleanup-toggle-knob');
        const statusText = document.getElementById('auto-cleanup-status-text');

        if (autoCleanupState.enabled) {
            toggle.classList.remove('bg-gray-200');
            toggle.classList.add('bg-indigo-600');
            toggle.setAttribute('aria-checked', 'true');
            knob.classList.remove('translate-x-0');
            knob.classList.add('translate-x-5');
            statusText.textContent = 'å¯ç”¨';
            statusText.classList.remove('text-red-600');
            statusText.classList.add('text-green-600');
        } else {
            toggle.classList.remove('bg-indigo-600');
            toggle.classList.add('bg-gray-200');
            toggle.setAttribute('aria-checked', 'false');
            knob.classList.remove('translate-x-5');
            knob.classList.add('translate-x-0');
            statusText.textContent = 'ç¦ç”¨';
            statusText.classList.remove('text-green-600');
            statusText.classList.add('text-red-600');
        }

        // Update last run text
        const lastRunText = document.getElementById('auto-cleanup-last-run');
        if (autoCleanupState.lastCleanup) {
            const date = new Date(autoCleanupState.lastCleanup);
            lastRunText.textContent = '(ä¸Šæ¬¡æ¸…ç†: ' + date.toLocaleString('zh-CN') + ')';
        } else {
            lastRunText.textContent = '';
        }
    }

    // Execute manual cleanup
    async function executeManualCleanup() {
        if (!confirm('ç¡®å®šè¦ç«‹å³æ¸…ç†ç¼“å­˜å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ˜¨å¤©åŠä¹‹å‰çš„æ‰€æœ‰ç¼“å­˜æ–‡ä»¶ã€‚\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }

        const cleanupBtn = document.getElementById('manual-cleanup-btn');
        const originalText = cleanupBtn.textContent;
        cleanupBtn.disabled = true;
        cleanupBtn.innerHTML = '<span class="spinner"></span> æ¸…ç†ä¸­...';

        try {
            const response = await fetch('/super/settings/api/storage/cleanup/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keep_days: 2,
                }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
                const totalDeleted = data.total.deleted_count;
                const totalFreed = data.total.freed_space_human;

                showMessage(
                    `æ¸…ç†å®Œæˆï¼åˆ é™¤ ${totalDeleted} ä¸ªæ–‡ä»¶ï¼Œé‡Šæ”¾ ${totalFreed} ç©ºé—´`
                );

                // Refresh storage info after cleanup
                await loadStorageInfo();

                // Update last cleanup time
                autoCleanupState.lastCleanup = new Date().toISOString();
                updateAutoCleanupUI();
            } else {
                showMessage('æ¸…ç†å¤±è´¥: ' + (data.detail || data.message || 'æœªçŸ¥é”™è¯¯'), false);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('æ¸…ç†å¤±è´¥: ç½‘ç»œé”™è¯¯', false);
        } finally {
            cleanupBtn.disabled = false;
            cleanupBtn.textContent = originalText;
        }
    }

    // Load auto cleanup config on page load
    async function loadAutoCleanupConfig() {
        try {
            const response = await fetch('/super/settings/api/storage/cleanup/config');
            if (response.ok) {
                const data = await response.json();
                autoCleanupState.enabled = data.enabled;
                autoCleanupState.lastCleanup = data.last_cleanup;
                updateAutoCleanupUI();
            }
        } catch (error) {
            console.error('Failed to load auto cleanup config:', error);
        }
    }

    // Add storage info loading to page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load storage info
        loadStorageInfo();

        // Load auto cleanup config
        loadAutoCleanupConfig();
    });

</script>
{% endblock %}
