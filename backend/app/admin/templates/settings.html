{% extends "base.html" %}

{% block title %}系统设置{% endblock %}

{% block extra_head %}
<style>
    /* Range slider styling */
    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        margin-top: -8px;
    }

    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
    }

    input[type=range]::-moz-range-thumb {
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        border: none;
    }

    input[type=range]::-moz-range-track {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
    }

    input[type=range]:focus {
        outline: none;
    }

    input[type=range]:focus::-webkit-slider-runnable-track {
        background: #d1d5db;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                系统设置
            </h2>
        </div>
    </div>

    <!-- Audio Processing Settings -->
    <div class="mt-8 bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">音频处理设置</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">配置音频文件处理的相关参数</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <form id="audio-settings-form" class="space-y-6">
                <!-- Audio Chunk Size -->
                <div>
                    <label for="chunk-size" class="block text-sm font-medium text-gray-700">
                        音频切块大小 (MB)
                    </label>
                    <div class="mt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">5 MB</span>
                            <span id="chunk-size-value" class="text-lg font-semibold text-indigo-600">10 MB</span>
                            <span class="text-sm text-gray-500">25 MB</span>
                        </div>
                        <input
                            type="range"
                            id="chunk-size"
                            name="chunk_size_mb"
                            min="5"
                            max="25"
                            value="10"
                            class="mt-2"
                        >
                        <p class="mt-2 text-xs text-gray-500">
                            音频文件切块的大小，较大的值可以提高处理速度但会增加内存使用
                        </p>
                    </div>
                </div>

                <!-- Max Concurrent Threads -->
                <div>
                    <label for="max-threads" class="block text-sm font-medium text-gray-700">
                        最大并发线程数
                    </label>
                    <div class="mt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">1</span>
                            <span id="max-threads-value" class="text-lg font-semibold text-indigo-600">4</span>
                            <span class="text-sm text-gray-500">16</span>
                        </div>
                        <input
                            type="range"
                            id="max-threads"
                            name="max_concurrent_threads"
                            min="1"
                            max="16"
                            value="4"
                            class="mt-2"
                        >
                        <p class="mt-2 text-xs text-gray-500">
                            同时处理的最大线程数，较高的值可以加快处理速度但会增加系统负载
                        </p>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="pt-4 border-t border-gray-200">
                    <button
                        type="button"
                        onclick="saveAudioSettings()"
                        id="save-btn"
                        class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm"
                    >
                        保存设置
                    </button>
                    <span id="save-status" class="ml-3 text-sm hidden"></span>
                </div>
            </form>
        </div>
    </div>

    <!-- System Info -->
    <div class="mt-8 bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">系统信息</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                <div class="sm:col-span-1">
                    <dt class="text-sm font-medium text-gray-500">系统版本</dt>
                    <dd class="mt-1 text-sm text-gray-900">1.0.0</dd>
                </div>
                <div class="sm:col-span-1">
                    <dt class="text-sm font-medium text-gray-500">数据库状态</dt>
                    <dd class="mt-1 text-sm text-green-600">正常</dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<script>
    // Update slider values display
    const chunkSizeSlider = document.getElementById('chunk-size');
    const chunkSizeValue = document.getElementById('chunk-size-value');
    const maxThreadsSlider = document.getElementById('max-threads');
    const maxThreadsValue = document.getElementById('max-threads-value');

    // Load current settings on page load
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/super/settings/api/audio');
            if (response.ok) {
                const data = await response.json();
                if (data.chunk_size_mb !== undefined) {
                    chunkSizeSlider.value = data.chunk_size_mb;
                    chunkSizeValue.textContent = data.chunk_size_mb + ' MB';
                }
                if (data.max_concurrent_threads !== undefined) {
                    maxThreadsSlider.value = data.max_concurrent_threads;
                    maxThreadsValue.textContent = data.max_concurrent_threads;
                }
            }
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    });

    // Update display when slider moves
    chunkSizeSlider.addEventListener('input', function() {
        chunkSizeValue.textContent = this.value + ' MB';
    });

    maxThreadsSlider.addEventListener('input', function() {
        maxThreadsValue.textContent = this.value;
    });

    // Save audio settings
    async function saveAudioSettings() {
        const saveBtn = document.getElementById('save-btn');
        const saveStatus = document.getElementById('save-status');

        // Disable button and show loading
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';
        saveStatus.classList.add('hidden');

        try {
            const response = await fetch('/super/settings/api/audio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chunk_size_mb: parseInt(chunkSizeSlider.value),
                    max_concurrent_threads: parseInt(maxThreadsSlider.value),
                }),
            });

            const data = await response.json();

            if (response.ok) {
                saveStatus.textContent = '保存成功';
                saveStatus.classList.remove('hidden', 'text-red-600');
                saveStatus.classList.add('text-green-600');

                // Hide success message after 3 seconds
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 3000);
            } else {
                saveStatus.textContent = '保存失败: ' + (data.detail || data.message || '未知错误');
                saveStatus.classList.remove('hidden', 'text-green-600');
                saveStatus.classList.add('text-red-600');
            }
        } catch (error) {
            saveStatus.textContent = '保存失败: 网络错误';
            saveStatus.classList.remove('hidden', 'text-green-600');
            saveStatus.classList.add('text-red-600');
        } finally {
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = '保存设置';
        }
    }
</script>
{% endblock %}
