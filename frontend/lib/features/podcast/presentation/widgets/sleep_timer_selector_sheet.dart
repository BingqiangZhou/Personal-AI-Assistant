import 'package:flutter/material.dart';
import '../../../../core/localization/app_localizations.dart';

/// Represents the user's sleep timer selection.
class SleepTimerSelection {
  /// Duration-based timer (null if after-episode mode).
  final Duration? duration;

  /// If true, stop after the current episode ends.
  final bool afterEpisode;

  /// If true, cancel the current timer.
  final bool cancel;

  const SleepTimerSelection({
    this.duration,
    this.afterEpisode = false,
    this.cancel = false,
  });

  const SleepTimerSelection.afterEpisode()
      : duration = null,
        afterEpisode = true,
        cancel = false;

  const SleepTimerSelection.cancel()
      : duration = null,
        afterEpisode = false,
        cancel = true;
}

/// Preset durations for the sleep timer.
const _kSleepTimerPresets = [
  Duration(minutes: 5),
  Duration(minutes: 10),
  Duration(minutes: 15),
  Duration(minutes: 30),
  Duration(minutes: 45),
  Duration(minutes: 60),
  Duration(minutes: 90),
];

String _formatPresetDuration(Duration d, BuildContext context) {
  final l10n = AppLocalizations.of(context)!;
  if (d.inMinutes >= 60) {
    final hours = d.inHours;
    final mins = d.inMinutes.remainder(60);
    return mins > 0 ? l10n.player_hours_minutes(hours, mins) : l10n.player_hours(hours);
  }
  return l10n.player_minutes(d.inMinutes);
}

/// Shows a bottom sheet for selecting a sleep timer option.
Future<SleepTimerSelection?> showSleepTimerSelectorSheet({
  required BuildContext context,
  required bool isTimerActive,
}) {
  return showModalBottomSheet<SleepTimerSelection>(
    context: context,
    showDragHandle: true,
    builder: (context) {
      final theme = Theme.of(context);
      final l10n = AppLocalizations.of(context)!;

      return SafeArea(
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.fromLTRB(16, 8, 16, 16),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.player_sleep_timer_title,
                  style: theme.textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.w700,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  l10n.player_sleep_timer_desc,
                  style: theme.textTheme.bodySmall?.copyWith(
                    color: theme.colorScheme.onSurfaceVariant,
                  ),
                ),
                const SizedBox(height: 16),
                // Duration presets
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: _kSleepTimerPresets.map((preset) {
                    return ActionChip(
                      label: Text(_formatPresetDuration(preset, context)),
                      onPressed: () {
                        Navigator.of(context).pop(
                          SleepTimerSelection(duration: preset),
                        );
                      },
                    );
                  }).toList(),
                ),
                const SizedBox(height: 12),
                const Divider(),
                // After current episode
                ListTile(
                  contentPadding: EdgeInsets.zero,
                  leading: Icon(
                    Icons.stop_circle_outlined,
                    color: theme.colorScheme.primary,
                  ),
                  title: Text(AppLocalizations.of(context)!.player_stop_after_episode),
                  onTap: () {
                    Navigator.of(context).pop(
                      const SleepTimerSelection.afterEpisode(),
                    );
                  },
                ),
                // Cancel timer (only when active)
                if (isTimerActive) ...[
                  const Divider(),
                  ListTile(
                    contentPadding: EdgeInsets.zero,
                    leading: Icon(
                      Icons.timer_off,
                      color: theme.colorScheme.error,
                    ),
                    title: Text(
                      l10n.player_cancel_timer,
                      style: TextStyle(color: theme.colorScheme.error),
                    ),
                    onTap: () {
                      Navigator.of(context).pop(
                        const SleepTimerSelection.cancel(),
                      );
                    },
                  ),
                ],
              ],
            ),
          ),
        ),
      );
    },
  );
}
