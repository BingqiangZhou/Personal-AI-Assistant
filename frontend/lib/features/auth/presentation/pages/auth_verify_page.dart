import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

import '../../../../core/app/config/app_config.dart';

/// Authentication Verification Page - Direct API Testing
/// This page bypasses complex build issues and tests backend connectivity directly
class AuthVerifyPage extends StatefulWidget {
  const AuthVerifyPage({super.key});

  @override
  State<AuthVerifyPage> createState() => _AuthVerifyPageState();
}

class _AuthVerifyPageState extends State<AuthVerifyPage> {
  String _status = 'Ready to test...';
  Color _statusColor = Colors.grey;

  String get baseUrl => '${AppConfig.serverBaseUrl}/api/v1/auth';

  Future<void> _testBackendHealth() async {
    setState(() {
      _status = 'Testing backend connectivity...';
      _statusColor = Colors.blue;
    });

    try {
      final response = await http.get(Uri.parse('$baseUrl/health'))
          .timeout(const Duration(seconds: 5));

      if (response.statusCode == 200) {
        setState(() {
          _status = '‚úÖ Backend is reachable and healthy!';
          _statusColor = Colors.green;
        });
      } else {
        setState(() {
          _status = '‚ùå Backend responded with status: ${response.statusCode}';
          _statusColor = Colors.orange;
        });
      }
    } catch (e) {
      setState(() {
        _status = '‚ùå Failed to connect: $e\n\nMake sure backend Docker is running on port 8000';
        _statusColor = Colors.red;
      });
    }
  }

  Future<void> _testRegister() async {
    setState(() {
      _status = 'Testing registration...';
      _statusColor = Colors.blue;
    });

    try {
      final response = await http.post(
        Uri.parse('$baseUrl/register'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email': 'flutter_verify@example.com',
          'password': 'Verify1234',
          'username': 'flutter_verify',
          'full_name': 'Flutter Verify User'
        }),
      ).timeout(const Duration(seconds: 10));

      final data = jsonDecode(utf8.decode(response.bodyBytes));

      if (response.statusCode == 200) {
        setState(() {
          _status = '‚úÖ Registration SUCCESS!\n\nUser: ${data['email']}\nID: ${data['id']}\n\nNow try login to get tokens.';
          _statusColor = Colors.green;
        });
      } else if (response.statusCode == 409) {
        setState(() {
          _status = '‚ÑπÔ∏è Email already exists (this is OK for repeat tests)';
          _statusColor = Colors.orange;
        });
      } else {
        setState(() {
          _status = '‚ùå Registration failed: ${data['detail'] ?? response.body}';
          _statusColor = Colors.red;
        });
      }
    } catch (e) {
      setState(() {
        _status = '‚ùå Error: $e';
        _statusColor = Colors.red;
      });
    }
  }

  Future<void> _testLogin() async {
    setState(() {
      _status = 'Testing login...';
      _statusColor = Colors.blue;
    });

    try {
      final response = await http.post(
        Uri.parse('$baseUrl/login'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email_or_username': 'flutter_verify@example.com',
          'password': 'Verify1234'
        }),
      ).timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final data = jsonDecode(utf8.decode(response.bodyBytes));
        final accessToken = data['access_token'] as String;
        final refreshToken = data['refresh_token'] as String;

        setState(() {
          _status = '‚úÖ Login SUCCESS!\n\nAccess Token: ${accessToken.substring(0, 30)}...\nRefresh Token: ${refreshToken.substring(0, 30)}...\n\nTry "Get User Info" to verify token works!';
          _statusColor = Colors.green;
        });
      } else {
        final data = tryJsonDecode(response.body);
        setState(() {
          _status = '‚ùå Login failed: $data';
          _statusColor = Colors.red;
        });
      }
    } catch (e) {
      setState(() {
        _status = '‚ùå Error: $e';
        _statusColor = Colors.red;
      });
    }
  }

  Future<void> _testGetUser() async {
    setState(() {
      _status = 'Getting user info (needs login first)...';
      _statusColor = Colors.blue;
    });

    // First get a token
    try {
      final loginResp = await http.post(
        Uri.parse('$baseUrl/login'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email_or_username': 'flutter_verify@example.com',
          'password': 'Verify1234'
        }),
      ).timeout(const Duration(seconds: 10));

      if (loginResp.statusCode != 200) {
        setState(() {
          _status = '‚ùå Need to login first. Login failed.';
          _statusColor = Colors.red;
        });
        return;
      }

      final loginData = jsonDecode(utf8.decode(loginResp.bodyBytes));
      final accessToken = loginData['access_token'];

      // Now get user info
      final userResp = await http.get(
        Uri.parse('$baseUrl/me'),
        headers: {'Authorization': 'Bearer $accessToken'},
      ).timeout(const Duration(seconds: 10));

      if (userResp.statusCode == 200) {
        final userData = jsonDecode(utf8.decode(userResp.bodyBytes));
        setState(() {
          _status = '‚úÖ User Info Retrieval SUCCESS!\n\n'
              'Email: ${userData['email']}\n'
              'Username: ${userData['username']}\n'
              'Full Name: ${userData['full_name']}\n'
              'User ID: ${userData['id']}';
          _statusColor = Colors.green;
        });
      } else {
        setState(() {
          _status = '‚ùå Get user failed: ${userResp.statusCode}';
          _statusColor = Colors.red;
        });
      }
    } catch (e) {
      setState(() {
        _status = '‚ùå Error: $e';
        _statusColor = Colors.red;
      });
    }
  }

  String tryJsonDecode(String body) {
    try {
      return jsonDecode(body).toString();
    } catch (e) {
      return body;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Auth Verification'),
        backgroundColor: Theme.of(context).colorScheme.primary,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Status Display
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: _statusColor.withValues(alpha: 0.1),
                border: Border.all(color: _statusColor),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(
                _status,
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                  color: _statusColor,
                  fontFamily: 'monospace',
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Test Buttons
            _TestButton(
              text: 'üîß 1. Check Backend Health',
              color: Theme.of(context).colorScheme.primary,
              onPressed: _testBackendHealth,
            ),
            const SizedBox(height: 8),

            _TestButton(
              text: 'üìù 2. Register New User',
              color: Theme.of(context).colorScheme.secondary,
              onPressed: _testRegister,
            ),
            const SizedBox(height: 8),

            _TestButton(
              text: 'üîì 3. Login (Get Tokens)',
              color: Theme.of(context).colorScheme.tertiary,
              onPressed: _testLogin,
            ),
            const SizedBox(height: 8),

            _TestButton(
              text: 'üë§ 4. Get User Info (with Token)',
              color: Theme.of(context).colorScheme.primaryContainer,
              onPressed: _testGetUser,
            ),
            const SizedBox(height: 20),

            // Instructions
            _buildInstructions(),
          ],
        ),
      ),
    );
  }

  Widget _buildInstructions() {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surfaceContainerHighest,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text('üìã Test Flow:',
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Theme.of(context).colorScheme.onSurfaceVariant)),
          const SizedBox(height: 6),
          Text('1. Must run Backend Docker first (port 8000)', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
          Text('2. Click "Check Health" to verify connection', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
          Text('3. Click "Register" to create test user', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
          Text('4. Click "Login" to get access/refresh tokens', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
          Text('5. Click "Get User Info" to verify tokens work', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
          Text('6. If all pass ‚Üí Backend ‚úÖ Ready!', style: TextStyle(color: Theme.of(context).colorScheme.onSurfaceVariant)),
        ],
      ),
    );
  }
}

class _TestButton extends StatelessWidget {
  final String text;
  final Color color;
  final VoidCallback onPressed;

  const _TestButton({
    required this.text,
    required this.color,
    required this.onPressed,
  });

  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: color,
        padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 20),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
      ),
      child: Text(
        text,
        style: const TextStyle(
          fontSize: 16,
          fontWeight: FontWeight.w600,
          fontFamily: 'monospace',
        ),
      ),
    );
  }
}
